define(["rias"],function(a){return function(d,k){function w(g){try{var c=g.apply(b,[h,d,k]),e,f;g="";if(c){c.code?e=c.code:1===c.success||!0===c.success?"GET"===h||"OPTIONS"===h?(e=b.responseCode.SC_OK,c.args&&"count"in c.args&&k.setHeader("Content-Range","items "+c.args.start+"-"+c.args.end+"/"+c.args.count)):e="PUT"===h?b.responseCode.SC_ACCEPTED:"POST"===h?b.responseCode.SC_CREATED:b.responseCode.SC_OK:e=b.responseCode.SC_INTERNAL_SERVER_ERROR;if(c.header)for(f in c.header)k.setHeader(f,c.header[f]);delete c.args;delete c.header;g="GET"===h?a.isString(c.value)?c.value:a.toJson(c.value):a.isString(c)?c:a.toJson(c);b.response(d,k,e,g);a.isDebug&&(t=new Date,a.log(0,"action",d,"response: ("+g.length+" B) - \u8017\u65f6\uff1a"+(t-u)+" \u6beb\u79d2\uff0c\u4ece"+a.datetime.format(u,"HH:mm:ss:SSS")+" \u5230 "+a.datetime.format(t,"HH:mm:ss:SSS")+"\n - result: "+(255>g.length?g:g.substr(0,252)+"...")+"\n"))}else a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",["no result.",m])+"\n"),b.response(d,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,m)}catch(l){a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",[l,m])+"\n"),b.response(d,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,m)}finally{}}var b=this,x=b._cacheAction,m=b.getRequestURL(d),e=b.getServletPath(d),f=b.getPathInfo(d),h=b.getMethod(d),l=b.getParameters(d),y,v;if("POST"===h)switch(b.getConditionSrv(0,d,"_method")){case "DELETE":h="DELETE";break;case "PUT":h="PUT"}var u=0,t=0;a.isDebug&&(u=new Date);delete l._define;delete l._meta;delete l._rsfs;v=b.getOper(d);a.log(1,"action",d,"params: "+a.toJson(l)+"\n");try{if(d.setCharacterEncoding("utf-8"),k.setContentType("text/html;charset\x3dutf-8"),"/act"===e){var f=a.trimStart(f,"/\\"),f=a.trimEnd(f,"/\\"),n=f.split("/"),e=[],p,r="",q;if(1>n.length)throw"Invalid act path...";n[0].startWith("rias")?(e.push("rias"),"rias"!==n[0]&&e.push(n[0]),e.push("act"),n.shift()):(r=b.appName+"/",e.push("serverApp"),e.push("act"));for(var l=0,z=n.length;l<z;l++){q=n[l];if(/\s|\./.test(q))throw"Invalid act path...";""!==q&&"webApp"!==q&&"rias"!==q&&e.push(q)}if(1>e.length)throw"Invalid act path...";p=e.join("/");if(!b.hasRight(v,f,h))throw a.log(2,"action",d,a.substitute("oper(${0}) has no right of action(${1}).${2}",[v.operCode,f,h])+"\n"),f+".hasNoRight";(y=x.get(r+p))?w(y):(a.isDebug&&a.log(0,"action",d,"Loading... "+r+p+"\n"),b.fileExists(p+".js",e[0])?a.require([r+p],function(a){x.put(r+p,a);w(a)}):(a.log(3,"action","Not Found:"+m+"\n"),b.response(d,k,b.responseCode.SC_NOT_FOUND,a.substitute(a.i18n.message.notfound,[m]))))}else a.log(2,"action","Not Found:"+m+"\n"),b.response(d,k,b.responseCode.SC_NOT_FOUND,a.substitute(a.i18n.message.notfound,[m]))}catch(g){a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.\n",[g,m])+"\n"),b.response(d,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,g.message)}}});