define(["rias"],function(a){return function(c,k){function x(f){try{var d=f.apply(b,[g,c,k]),e;f="";d?(e=d.code?d.code:1===d.success||!0===d.success?"GET"===g?b.responseCode.SC_OK:"PUT"===g?b.responseCode.SC_ACCEPTED:"POST"===g?b.responseCode.SC_CREATED:b.responseCode.SC_OK:b.responseCode.SC_INTERNAL_SERVER_ERROR,"GET"===g?(d.args&&"count"in d.args&&k.setHeader("Content-Range","items "+d.args.start+"-"+d.args.end+"/"+d.args.count),f=a.isString(d.value)?d.value:a.toJson(d.value)):a.isString(d)?f=d:(delete d.args,f=a.toJson(d)),b.response(c,k,e,f),a.isDebug&&(u=new Date,a.log(0,"action",c,"response: ("+f.length+" B) - \u8017\u65f6\uff1a"+(u-v)+" \u6beb\u79d2\uff0c\u4ece"+a.datetime.format(v,"HH:mm:ss:SSS")+" \u5230 "+a.datetime.format(u,"HH:mm:ss:SSS")+"\n - result: "+(255>f.length?f:f.substr(0,252)+"...")+"\n"))):(a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",["no result.",l])+"\n"),b.response(c,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,l))}catch(h){a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",[h,l])+"\n"),b.response(c,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,l)}finally{}}var b=this,y=b._cacheAction,l=b.getRequestURL(c),e=b.getServletPath(c),h=b.getPathInfo(c),g=b.getMethod(c),m=b.getParameters(c),t,w;if("POST"===g)switch(b.getConditionSrv(0,c,"_method")){case "DELETE":g="DELETE";break;case "PUT":g="PUT"}var v=0,u=0;a.isDebug&&(v=new Date);delete m._define;delete m._meta;delete m._rsfs;w=b.getOper(c);a.log(1,"action",c,"params: "+a.toJson(m)+"\n");try{if(c.setCharacterEncoding("utf-8"),k.setContentType("text/html;charset\x3dutf-8"),"/act"===e){var h=a.trimStart(h,"/\\"),h=a.trimEnd(h,"/\\"),n=h.split("/"),e=[],p,q="",r;if(1>n.length)throw"Invalid act path...";n[0].startWith("rias")?(e.push("rias"),"rias"!==n[0]&&e.push(n[0]),e.push("act"),n.shift()):(q=b.appName+"/",e.push("serverApp"),e.push("act"));for(var m=0,z=n.length;m<z;m++){r=n[m];if(/\s|\./.test(r))throw"Invalid act path...";""!==r&&"webApp"!==r&&"rias"!==r&&e.push(r)}if(1>e.length)throw"Invalid act path...";p=e.join("/");if(!b.hasRight(w,h,g))throw a.log(2,"action",c,a.substitute("oper(${0}) has no right of action(${1}).${2}",[w.operCode,h,g])+"\n"),h+".hasNoRight";t=y.get(q+p);a.isDebug&&t&&a.log(0,"action",c,"From cache: "+q+p+"\n");t?x(t):(a.isDebug&&a.log(0,"action",c,"Loading... "+q+p+"\n"),b.fileExists(p+".js",e[0])?a.require([q+p],function(a){y.put(q+p,a);x(a)}):(a.log(3,"action","Not Found:"+l+"\n"),b.response(c,k,b.responseCode.SC_NOT_FOUND,a.substitute(a.i18n.message.notfound,[l]))))}else a.log(2,"action","Not Found:"+l+"\n"),b.response(c,k,b.responseCode.SC_NOT_FOUND,a.substitute(a.i18n.message.notfound,[l]))}catch(f){a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.\n",[f,l])+"\n"),b.response(c,k,b.responseCode.SC_INTERNAL_SERVER_ERROR,f.message)}}});