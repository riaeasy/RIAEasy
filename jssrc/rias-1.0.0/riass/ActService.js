define(["rias","rias/riass/ServerApp","rias/riass/logAct"],function(a,M,N){return function(d,l){function q(e,b,d,g,k,c){try{a.host.WebUtil.response(b,g,d,k)}catch(J){h=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.host.WebUtil.response(b,f.getRequestURL(e),h,!1),a.log(3,n,e,"Response error: "+J+"\n"),console.error(J)}}function O(e){var b;try{z=new Date;try{b=e.apply(f,[g,d,l])}finally{z=new Date-z}if(b){b=a.mixin({},b);if(b.responseCode)h=b.responseCode;else if(1===b.success||!0===b.success)if("GET"===g||"OPTIONS"===g)h=a.host.responseCode.SC_OK,b.args&&"count"in b.args&&l.setHeader("Content-Range","items "+b.args.start+"-"+b.args.end+"/"+b.args.count);else if("PUT"===g)h=a.host.responseCode.SC_ACCEPTED;else if("POST"===g)h=a.host.responseCode.SC_CREATED;else{if("DELETE"!==g&&"TOEXCEL"===g){var k=b.value,c=a.fromJson(f.fetchByName(d,"_responseargs",a.host._typeStr)||"{}"),p;e=0;c._downloadFileType&&(p={_downloadType:c._downloadType,_downloadFileType:c._downloadFileType,value:k,filename:c.filename,sheet:c.sheet,title:c.title,columns:c.columns,numrowLabel:c.numrowLabel,numrowWidth:c.numrowWidth,group:c.group,total:c.total,dateformat:c.dateformat,timeformat:c.timeformat,thousandSeparator:c.thousandSeparator,decimalSeparator:c.decimalSeparator},e=a.host.toExcel(d,l,p),0<=e&&(r="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u6210\u529f\uff0c\u5171"+e+"\u5b57\u8282."));0>e&&(r="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u5931\u8d25...");return}h=a.host.responseCode.SC_OK}else h=a.host.responseCode.SC_INTERNAL_SERVER_ERROR;if(b.header)for(A in b.header)b.header.hasOwnProperty(A)&&l.setHeader(A,b.header[A]);delete b.args;delete b.header;r="GET"===g?a.isString(b.value)?b.value:a.toJson(b.value):a.isString(b)?b:a.toJson(b);q(d,l,h,r,!0);a.isDebug&&(x=new Date,a.log(0,n,d,"response: ("+r.length+" B) - \u8017\u65f6\uff1a"+(x-B)+" \u6beb\u79d2\uff0c\u4ece"+a.formatDatetime(B,"HH:mm:ss:SSS")+" \u5230 "+a.formatDatetime(x,"HH:mm:ss:SSS")+"\n - result: "+(255>r.length?r:r.substring(0,250)+"...")))}else a.log(3,n,a.substitute("ActService Error: ${0}, url: '${1}'.",["no result.",m])+"\n"),q(d,l,h,m)}catch(I){h=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.log(3,n,a.substitute("ActService Error: ${0}, url: '${1}'.\n",[I,m]),I),q(d,l,h,m)}finally{}}function P(){x=new Date;var e=f.getParameters(d),b=f.getRemoteIp(d);120<b.length&&(b=b.substring(0,120)+"...");delete e._define;delete e._meta;delete e._rsfs;delete e._rsf;e=a.toJson(e);250<e.length&&(e=e.substring(0,250)+"...");a.isDebug&&a.log(0,n,d,"params: "+e);try{N.apply(f,[{serverid:f.getLocalPort(d),cat:c.appName,url:t,method:g,params:e,stat:h,dtcreate:B,opcreate:C.id||0,client:b,dms:x-B,dmsact:z}])}catch(H){a.log(3,n,"logAct error: "+m+"\n"+H,H)}}var B=new Date,x=0,z=0,c=this,F=c.actCache,f=c.apps.get(c.appName),n="actionEngine["+c.actiongEngineId+"] - "+c.appName;f||(a.synRequire([c.appName],function(e){f=a.safeMixin(new M({appConfig:c.appConfig,appName:c.appName,defaultDbName:c.appConfig.defaultDbName,dbs:c.dbs}),e)}),c.apps.put(c.appName,f));var m=f.getRequestURI(d),K=f.getServletPath(d),t=K+f.getPathInfo(d),g=f.getMethod(d),k=f.getConditionSrv(0,d,"_method"),C=f.getOper(d),h=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,A,r="";f.caches={actCache:F,pageHtmlCache:c.pageHtmlCache,appModuleCache:c.appModuleCache};g&&(g=g.toUpperCase());k&&(k=k.toUpperCase());"GET"===g&&k&&(g=k);if("POST"===g)switch(k){case "DELETE":g="DELETE";break;case "PUT":g="PUT";break;default:k&&(g=k)}var G,u,p,k=[],v="",w,D,L,y;try{if(d.setCharacterEncoding("utf-8"),l.setContentType("text/html;charset\x3dutf-8"),t){var E={success:!0,value:""};switch(K){case "/act":if(f.hasRightOf(f.actRight,t,g,C,E)){G=f.actMapper[t.toLowerCase()]||{};if(G.filePath)u=G.filePath,k=u.split("/"),k[0].startWith("rias")||(v=f.appName+"/");else{p=t.split("/");if(3>p.length)throw"Invalid act path...";p[2].startWith("rias")?(k.push("rias"),"rias"!==p[2]&&k.push(p[2]),k.push("act"),p.shift()):(v=f.appName+"/",k.push("serverApp"),k.push("act"));D=2;for(L=p.length;D<L;D++){w=p[D];if(/\s|\./.test(w))throw"Invalid act path...";""!==w&&"webApp"!==w&&"rias"!==w&&k.push(w)}u=k.join("/")}y=F.get(v+u);y||(a.log(0,n,d,"Loading... "+v+u),a.synRequire([v+u],function(a){y=a;F.put(v+u,a)}));y?O(y):(h=a.host.responseCode.SC_NOT_FOUND,a.log(3,n,a.substitute(a.i18n.message.notfound,[m])+"\n"),q(d,l,h,a.substitute(a.i18n.message.notfound,[m])))}else a.log(2,n,a.substitute("oper(${0}[${1}]) has no right of act(${2}).${3}",[C.id,C.code,t,g])+"\n"),h=E.responseCode,q(d,l,E.responseCode,E.value);break;default:h=a.host.responseCode.SC_NOT_FOUND,a.log(2,n,a.substitute(a.i18n.message.notfound,[m])+"\n"),q(d,l,h,a.substitute(a.i18n.message.notfound,[m]))}}else h=a.host.responseCode.SC_NOT_FOUND,a.log(2,n,a.substitute(a.i18n.message.notfound,[m])+"\n"),q(d,l,h,a.substitute(a.i18n.message.notfound,[m]))}catch(e){h=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.log(3,n,a.substitute("ActService Error: ${0}, url: '${1}'.\n",[e,m]),e),q(d,l,h,m)}f.canDo_actLog(t,g)&&P();c.isRunning=!1}});