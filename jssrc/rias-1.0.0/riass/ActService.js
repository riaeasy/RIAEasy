define(["rias","rias/riass/ServerApp","rias/riass/xactslog"],function(a,L,M){return function(b,m){function I(n){try{F=new Date;try{var c=n.apply(e,[f,b,m])}finally{F=new Date-F}if(c){if(c.code)g=c.code;else if(1===c.success||!0===c.success)if("GET"===f||"OPTIONS"===f)g=a.host.responseCode.SC_OK,c.args&&"count"in c.args&&m.setHeader("Content-Range","items "+c.args.start+"-"+c.args.end+"/"+c.args.count);else if("PUT"===f)g=a.host.responseCode.SC_ACCEPTED;else if("POST"===f)g=a.host.responseCode.SC_CREATED;else{if("DELETE"!==f&&"TOEXCEL"===f){var d=c.value,k=a.fromJson(e.fetchByName(b,"_responseargs",a.host._typeStr)||"{}"),h;n=0;k._downloadFileType&&(h={_downloadType:k._downloadType,_downloadFileType:k._downloadFileType,value:d,filename:k.filename,sheet:k.sheet,title:k.title,columns:k.columns,numrowLabel:k.numrowLabel,numrowWidth:k.numrowWidth,group:k.group,total:k.total,dateformat:k.dateformat,timeformat:k.timeformat,thousandSeparator:k.thousandSeparator,decimalSeparator:k.decimalSeparator},n=a.host.toExcel(b,m,h),0<=n&&(r="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u6210\u529f\uff0c\u5171"+n+"\u5b57\u8282."));0>n&&(r="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u5931\u8d25...");return}g=a.host.responseCode.SC_OK}else g=a.host.responseCode.SC_INTERNAL_SERVER_ERROR;if(c.header)for(G in c.header)c.header.hasOwnProperty(G)&&m.setHeader(G,c.header[G]);delete c.args;delete c.header;r="GET"===f?a.isString(c.value)?c.value:a.toJson(c.value):a.isString(c)?c:a.toJson(c);v(b,m,g,r,!0);a.isDebug&&(D=new Date,a.log(0,p,b,"response: ("+r.length+" B) - \u8017\u65f6\uff1a"+(D-H)+" \u6beb\u79d2\uff0c\u4ece"+a.formatDatetime(H,"HH:mm:ss:SSS")+" \u5230 "+a.formatDatetime(D,"HH:mm:ss:SSS")+"\n - result: "+(255>r.length?r:r.substr(0,252)+"...")))}else a.log(3,p,a.substitute("ActService Error: ${0}, url: '${1}'.",["no result.",q])+"\n"),v(b,m,g,q)}catch(l){g=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.log(3,p,a.substitute("ActService Error: ${0}, url: '${1}'.",[l,q]),l),v(b,m,g,q)}finally{}}var v=function(b,c,d,f,h,m){try{a.host.WebUtil.response(c,f,d,h)}catch(l){g=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.host.WebUtil.response(c,e.getRequestURL(b),g,!1),a.log(3,p,b,"Response error: "+l+"\n",l)}},w=this,J=w.actionCache,h=w.apps,z=w.appName,K=w.appConfig,e=h.get(z),p="actEngine["+w.actEngineId+"] - "+z;e||(a.require([z],function(b){e=a.safeMixin(new L({appName:z,defaultDbName:K.defaultDbName,dbs:w.dbs,xactslog:K.xactslog}),b)}),h.put(z,e));var q=e.getRequestURI(b),A=e.getServletPath(b),x=e.getPathInfo(b),f=e.getMethod(b).toUpperCase(),d=e.getConditionSrv(0,b,"_method"),h=e.getParameters(b),y,E=e.getOper(b);e.setAttribute(b,"oper",E);var H=new Date,D=0,F=0,g=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,G,r="";d&&(d=d.toUpperCase());"GET"===f&&d&&(f=d);if("POST"===f)switch(d){case "DELETE":f="DELETE";break;case "PUT":f="PUT";break;default:d&&(f=d)}var t,d=[],u,B="",C;delete h._define;delete h._meta;delete h._rsfs;delete h._rsf;h=a.toJson(h);250<h.length&&(h=h.substring(0,250)+"...");a.isDebug&&a.log(0,p,b,"params: "+h);try{if(b.setCharacterEncoding("utf-8"),m.setContentType("text/html;charset\x3dutf-8"),"/act"===A){if(x=a.trimStartChars(x,"/\\"),x=a.trimEndChars(x,"/\\")){var l=e.actMapper[x]||{},A={success:!0,value:""};if(e.hasRightOfAct(A,E,f,l.requireLogged,l.requireRights)){if(l&&l.filePath)u=l.filePath,d=u.split("/"),d[0].startWith("rias")||(B=e.appName+"/");else{t=x.split("/");if(1>t.length)throw"Invalid cmd path...";t[0].startWith("rias")?(d.push("rias"),"rias"!==t[0]&&d.push(t[0]),d.push("act"),t.shift()):(B=e.appName+"/",d.push("serverApp"),d.push("act"));for(var l=0,N=t.length;l<N;l++){C=t[l];if(/\s|\./.test(C))throw"Invalid act path...";""!==C&&"webApp"!==C&&"rias"!==C&&d.push(C)}u=d.join("/")}(y=J.get(B+u))?I(y):(a.isDebug&&a.log(0,p,b,"Loading... "+B+u),e.fileExists(u+".js",d[0])?a.require([B+u],function(a){J.put(B+u,a);I(a)}):(g=a.host.responseCode.SC_NOT_FOUND,a.log(3,p,"Not Found:"+q+"\n"),v(b,m,g,a.substitute(a.i18n.message.notfound,[q]))))}else a.log(2,p,a.substitute("oper(${0}[${1}]) has no right of act(${2}).${3}",[E.id,E.code,x,f])+"\n"),g=A.code,v(b,m,A.code,A.value)}}else g=a.host.responseCode.SC_NOT_FOUND,a.log(2,p,"Not Found:"+q+"\n"),v(b,m,g,a.substitute(a.i18n.message.notfound,[q]))}catch(n){g=a.host.responseCode.SC_INTERNAL_SERVER_ERROR,a.log(3,p,a.substitute("ActService Error: ${0}, url: '${1}'.\n",[n,q]),n),v(b,m,g,n.message)}if(e.xactslog&&(1==e.xactslog||"POST"===f||"PUT"===f)){D=new Date;y=a.host.getRemoteIp(b);120<y.length&&(y=y.substring(0,120)+"...");try{M.apply(e,[{serverid:b.getLocalPort(),cat:z,url:q,method:f,params:h,stat:g,dtcreate:H,opcreate:E.id||0,client:y,dms:D-H,dmsact:F}])}catch(n){a.log(3,p,"xactslog error: "+q+"\n"+n,n)}}w.isRunning=!1}});