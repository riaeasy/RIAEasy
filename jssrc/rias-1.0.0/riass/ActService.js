define(["rias","rias/riass/AppServer","rias/riass/xactslog"],function(a,F,K){var l=F.responseCode;return function(d,m){function G(b){try{C=new Date;var c=b.apply(h,[f,d,m,H]);C=new Date-C;if(c=a.mixinDeep({},c)){if(c.code)e=c.code;else if(1===c.success||!0===c.success)if("GET"===f||"OPTIONS"===f)e=l.SC_OK,c.args&&"count"in c.args&&m.setHeader("Content-Range","items "+c.args.start+"-"+c.args.end+"/"+c.args.count);else if("PUT"===f)e=l.SC_ACCEPTED;else if("POST"===f)e=l.SC_CREATED;else{if("DELETE"!==f&&"TOEXCEL"===f){var q=c.value,g=a.fromJson(k._responseargs||"{}"),p;b=0;g._downloadFileType&&(p={_downloadType:g._downloadType,_downloadFileType:g._downloadFileType,value:q,filename:g.filename,sheet:g.sheet,title:g.title,columns:g.columns,numrowLabel:g.numrowLabel,numrowWidth:g.numrowWidth,group:g.group,total:g.total,dateformat:g.dateformat,timeformat:g.timeformat,thousandSeparator:g.thousandSeparator,decimalSeparator:g.decimalSeparator},b=a.host.toExcel(d,m,p),0<=b&&(t="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u6210\u529f\uff0c\u5171"+b+"\u5b57\u8282."));0>b&&(t="\u751f\u6210\u4e0b\u8f7d\u6570\u636e\u5931\u8d25...");return}e=l.SC_OK}else e=l.SC_INTERNAL_SERVER_ERROR;if(c.header)for(D in c.header)c.header.hasOwnProperty(D)&&m.setHeader(D,c.header[D]);delete c.args;delete c.header;t="GET"===f?a.isString(c.value)?c.value:a.toJson(c.value):a.isString(c)?c:a.toJson(c);u(d,m,e,t,!0);a.isDebug&&(x=new Date,a.log(0,"action",d,"response: ("+t.length+" B) - \u8017\u65f6\uff1a"+(x-y)+" \u6beb\u79d2\uff0c\u4ece"+a.formatDatetime(y,"HH:mm:ss:SSS")+" \u5230 "+a.formatDatetime(x,"HH:mm:ss:SSS")+"\n - result: "+(255>t.length?t:t.substr(0,252)+"...")))}else a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",["no result.",n])+"\n"),u(d,m,e,n)}catch(r){e=l.SC_INTERNAL_SERVER_ERROR,a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.",[r,n])+"\n"),u(d,m,e,n)}finally{}}var u=function(b,c,d,g,f,h){try{com.riastudio.util.WebUtil.response(c,g,d,f)}catch(k){e=l.SC_INTERNAL_SERVER_ERROR,com.riastudio.util.WebUtil.response(c,this.getRequestURL(b),e,!1),a.log(3,"ActService",b,"Response error: "+k+"\n")}},I=this.actionCache,q=this.apps,E=this.appName,r=this.appConfig,h=q.get(E);h||(h=new F({appName:E,defaultDbName:r.defaultDbName,dbs:this.dbs}),q.put(E,h));var n=h.getRequestURI(d),q=h.getServletPath(d),z=h.getPathInfo(d),f=h.getMethod(d).toUpperCase(),b=h.getConditionSrv(0,d,"_method"),k=h.getParameters(d),J,H=h.getOper(d),y=0,x=0,C=0;a.isDebug&&(y=new Date);var e=l.SC_INTERNAL_SERVER_ERROR,D,t="";b&&(b=b.toUpperCase());"GET"===f&&b&&(f=b);if("POST"===f)switch(b){case "DELETE":f="DELETE";break;case "PUT":f="PUT";break;default:b&&(f=b)}var p,b=[],v,A="",w;delete k._define;delete k._meta;delete k._rsfs;delete k._rsf;k=a.toJson(k);250<k.length&&(k=k.substring(0,250)+"...");a.isDebug&&a.log(0,"action",d,"params: "+k);try{if(d.setCharacterEncoding("utf-8"),m.setContentType("text/html;charset\x3dutf-8"),"/act"===q){z=a.trimStartChars(z,"/\\");z=a.trimEndChars(z,"/\\");p=z.split("/");if(1>p.length)throw"Invalid act path...";p[0].startWith("rias")?(b.push("rias"),"rias"!==p[0]&&b.push(p[0]),b.push("act"),p.shift()):(A=h.appName+"/",b.push("serverApp"),b.push("act"));for(var q=0,L=p.length;q<L;q++){w=p[q];if(/\s|\./.test(w))throw"Invalid act path...";""!==w&&"webApp"!==w&&"rias"!==w&&b.push(w)}if(1>b.length)throw"Invalid act path...";v=b.join("/");(J=I.get(A+v))?G(J):(a.isDebug&&a.log(0,"action",d,"Loading... "+A+v),h.fileExists(v+".js",b[0])?a.require([A+v],function(a){I.put(A+v,a);G(a)}):(e=l.SC_NOT_FOUND,a.log(3,"action","Not Found:"+n+"\n"),u(d,m,e,a.substitute(a.i18n.message.notfound,[n]))))}else e=l.SC_NOT_FOUND,a.log(2,"action","Not Found:"+n+"\n"),u(d,m,e,a.substitute(a.i18n.message.notfound,[n]))}catch(B){e=l.SC_INTERNAL_SERVER_ERROR,a.log(3,"action",a.substitute("action Servlet Error: ${0}, url: '${1}'.\n",[B,n])+"\n"),u(d,m,e,B.message)}if(1==r.xactslog){x=new Date;r=com.riastudio.util.WebUtil.getRemoteIpAddr(d,!1);120<r.length&&(r=r.substring(0,120)+"...");try{K.apply(h,[{serverid:d.getLocalPort(),cat:E,url:n,method:f,params:k,stat:e,dtcreate:y,opcreate:H.code||0,client:r,dms:x-y,dmsact:C}])}catch(B){a.log(3,"action","xactslog error: "+n+"\n"+B+"\n")}}this.isRunning=!1}});