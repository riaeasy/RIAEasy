define(["rias/riass/riass","rias/riass/FileMixin"],function(d,l){function q(b,m){function a(b){var c;if(!b.dbName||!b.dbConfig)throw Error("loadDbs has no dbName or dbConfig.",b);try{d.log(1,"AppServer["+e.appName+"]","Setting DB Connection ..."+b.dbName),"mysql"==b.dbType&&d.require(["rias/riasdb/DbMySQL"],function(a){try{b={server:e,dbTables:b.dbTables,dbName:b.dbName,dbConfig:b.dbConfig,maxResultRecords:m},b.dbTables||(b.afterGetDbDefine=function(m){try{var a="serverApp/db/"+b.dbName.replace(/\\|\//,"_")+".json";e.writeJson(a,"serverApp",m,{},!0);d.log(1,"AppServer["+e.appName+"]","Save DB define in "+a)}catch(c){d.log(3,"AppServer["+e.appName+"]","Save DB define Error: '"+b.dbName+"', "+c)}}),c=new a(b),e.dbs[b.dbName]=c,b.dbTables||c.getDbDefine()}catch(f){d.log(3,"AppServer["+e.appName+"]","Setting DB Connection Error: '"+b.dbName+"', "+f)}})}catch(f){d.log(3,"AppServer["+e.appName+"]","Setting DB Connection Error: '"+g+"', "+f)}}var e=this,g,f;for(g in e.dbs)e.dbs.hasOwnProperty(g)&&(f=e.dbs[g],d.isString(f)?b.hasOwnProperty(f)&&(g=f,f=b[f],d.isObjectSimple(f)&&a({dbType:f.dbType,dbTables:void 0,dbName:g,dbConfig:f})):d.isObjectSimple(f)&&a(f));e.defaultDb=e.dbs[e.defaultDbName];e.defaultDb||d.log(2,"AppServer["+e.appName+"]","There's no defaultDb: '"+e.defaultDbName+"'.")}var a=javax.servlet.http.HttpServletResponse,p={SC_CONTINUE:a.SC_CONTINUE,SC_SWITCHING_PROTOCOLS:a.SC_SWITCHING_PROTOCOLS,SC_OK:a.SC_OK,SC_CREATED:a.SC_CREATED,SC_ACCEPTED:a.SC_ACCEPTED,SC_NON_AUTHORITATIVE_INFORMATION:a.SC_NON_AUTHORITATIVE_INFORMATION,SC_NO_CONTENT:a.SC_NO_CONTENT,SC_RESET_CONTENT:a.SC_RESET_CONTENT,SC_PARTIAL_CONTENT:a.SC_PARTIAL_CONTENT,SC_MULTIPLE_CHOICES:a.SC_MULTIPLE_CHOICES,SC_MOVED_PERMANENTLY:a.SC_MOVED_PERMANENTLY,SC_MOVED_TEMPORARILY:a.SC_MOVED_TEMPORARILY,SC_FOUND:a.SC_FOUND,SC_SEE_OTHER:a.SC_SEE_OTHER,SC_NOT_MODIFIED:a.SC_NOT_MODIFIED,SC_USE_PROXY:a.SC_USE_PROXY,SC_TEMPORARY_REDIRECT:a.SC_TEMPORARY_REDIRECT,SC_BAD_REQUEST:a.SC_BAD_REQUEST,SC_UNAUTHORIZED:a.SC_UNAUTHORIZED,SC_PAYMENT_REQUIRED:a.SC_PAYMENT_REQUIRED,SC_FORBIDDEN:a.SC_FORBIDDEN,SC_NOT_FOUND:a.SC_NOT_FOUND,SC_METHOD_NOT_ALLOWED:a.SC_METHOD_NOT_ALLOWED,SC_NOT_ACCEPTABLE:a.SC_NOT_ACCEPTABLE,SC_PROXY_AUTHENTICATION_REQUIRED:a.SC_PROXY_AUTHENTICATION_REQUIRED,SC_REQUEST_TIMEOUT:a.SC_REQUEST_TIMEOUT,SC_CONFLICT:a.SC_CONFLICT,SC_GONE:a.SC_GONE,SC_LENGTH_REQUIRED:a.SC_LENGTH_REQUIRED,SC_PRECONDITION_FAILED:a.SC_PRECONDITION_FAILED,SC_REQUEST_ENTITY_TOO_LARGE:a.SC_REQUEST_ENTITY_TOO_LARGE,SC_REQUEST_URI_TOO_LONG:a.SC_REQUEST_URI_TOO_LONG,SC_UNSUPPORTED_MEDIA_TYPE:a.SC_UNSUPPORTED_MEDIA_TYPE,SC_REQUESTED_RANGE_NOT_SATISFIABLE:a.SC_REQUESTED_RANGE_NOT_SATISFIABLE,SC_EXPECTATION_FAILED:a.SC_EXPECTATION_FAILED,SC_INTERNAL_SERVER_ERROR:a.SC_INTERNAL_SERVER_ERROR,SC_NOT_IMPLEMENTED:a.SC_NOT_IMPLEMENTED,SC_BAD_GATEWAY:a.SC_BAD_GATEWAY,SC_SERVICE_UNAVAILABLE:a.SC_SERVICE_UNAVAILABLE,SC_GATEWAY_TIMEOUT:a.SC_GATEWAY_TIMEOUT,SC_HTTP_VERSION_NOT_SUPPORTED:a.SC_HTTP_VERSION_NOT_SUPPORTED},a=d.declare("rias.riass.AppServer",[d.ObjectBase,l],{debugLevel:d.host.debugLevel(),defaultLanguage:"zh",defaultDbName:"db/riastudio",defaultDb:null,create:function(b){this.appName=b.appName;delete b.appName;this.config=b||{};this.path||(this.path={});this.path.riasLib=this.getFilePathName(riasServerConfig.riasLib?riasServerConfig.riasLib:"jssrc/rias");this.path.webLib=this.getFilePathName(riasServerConfig.webLib?riasServerConfig.webLib:"jssrc/webLib");this.path.appRoot=this.getFilePathName(riasServerConfig.appsRoot?riasServerConfig.appsRoot+"/"+this.appName:"jssrc/riasApp");this._initPackagePath();this.defaultDbName=b.defaultDbName;this.dbs=b.dbs||{};q.apply(this,[riasServerConfig.dbConfigs,riasServerConfig.maxResultRecords]);var a=this;d.require(["dojo/i18n!"+this.appName+"/serverApp/nls/appi18n"],function(b){d.i18n[a.appName]=b})},destroy:function(b){d.forEach(this.dbs,function(b){d.destroy(b)});this.dbs=void 0;this.inherited(arguments)},encodeURI:function(b){return encodeURI(d.host.jsString(b))},decodeURI:function(b){return decodeURI(d.host.jsString(b))},isRequest:function(b){return!0},fetchByName:function(b,a,c){if(this.isRequest(b)){var e=this.getAttribute(b,a,c);return null==e?this.getParameter(b,a,c):d.host.jsType(e,c)}return d.host.jsType(b[a],c)},getParameter:function(b,a,c){a=b.getParameter(a);return null==a?null:d.host.jsType(a,c||_typeStr)},getAttribute:function(b,a,c){a=b.getAttribute(a);return null==a?null:d.host.jsType(a,c)},setAttribute:function(b,a,c){return b.setAttribute(a,c)},getAttributeNames:function(b){for(var a={},c,e=b.getAttributeNames();e.hasMoreElements();)c=d.host.jsString(e.nextElement()),a[c]=this.getAttribute(b,c);return a},getParameters:function(b){for(var a={},c,e=b.getParameterNames();e.hasMoreElements();)c=d.host.jsString(e.nextElement()),a[c]=this.getParameter(b,c);return a},getRequestURI:function(b){return this.decodeURI(b.getRequestURI())},getRequestURL:function(b){return this.decodeURI(b.getRequestURL())},getServletPath:function(b){return this.decodeURI(b.getServletPath())},getPathInfo:function(b){return this.decodeURI(b.getPathInfo())},getQueryString:function(b){return d.host.jsString(b.getQueryString())},getMethod:function(b){return d.host.jsString(b.getMethod())},getConditionSrv:function(b,a,c,e,d){return b?b.getCondition(a,c,e,d):this.defaultDb.getCondition(a,c,e,d)},getEqualStrSrv:function(b,a,c){return b?b.getEqualStr(a,c):this.defaultDb.getEqualStr(a,c)},getLikeStrSrv:function(b,a,c){return b?b.getLikeStr(a,c):this.defaultDb.getLikeStr(a,c)},getWhereSrv:function(b,a){return b?b.getWhere(a):this.defaultDb.getWhere(a)},getOrderBySrv:function(b,a,c){return b?b.getOrderBy(a,c):this.defaultDb.getOrderBy(a,c)},getLimitSrv:function(b,a,c){return b?b.getLimit(a,c):this.defaultDb.getLimit(a,c)},getSession:function(b){return null},getOper:function(b){return{code:"",name:"",rights:{}}},hasRight:function(b,a,c,e){for(var g=0,f=c.split("/"),h="",k=0,l=f.length,n={allFile:0,act:1,"act/login":1,"act/logout":1,"act/riasd":1};k<l;k++)h=0===k?f[0]:h+"/"+f[k],1==n[h]?g=1:void 0!==n[h]&&(g=0);return g?1:(b.code=p.SC_METHOD_NOT_ALLOWED,b.success=!1,b.value="\u7f3a\u5c11\u6743\u9650.",d.log(2,"AppServer["+this.appName+"]",d.substitute("oper(${0}) has no right of rightCode(${1}).${2}",[a.code,c,e])+"\n"),!1)},hasOrigin:function(b){this.origins||(this.origins={"http://localhost:8081":1,"http://127.0.0.1:8081":1,"http://www.riaeasy.com:8081":1});return!!this.origins[b]},setXdHeader:function(b,a,c,e,d){b=b.getHeader("Origin");return null==b?!0:this.hasRight(a,c,e,d)&&this.hasOrigin(b)?(a.header={"Access-Control-Allow-Origin":b,"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Headers":"X-Requested-With,X-Range,Range","Access-Control-Expose-Headers":"Accept-Ranges,Content-Encoding,Content-Length,Content-Range","Access-Control-Allow-Methods":"GET,POST,OPTIONS"},!0):!1}});a.responseCode=p;return a});