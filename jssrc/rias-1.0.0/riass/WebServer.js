define(["rias/riass/riass","rias/riass/FileMixin"],function(e,p){var b=javax.servlet.http.HttpServletResponse,q=java.nio.file.FileSystems.getDefault(),m=java.nio.file.StandardWatchEventKinds,r=m.ENTRY_CREATE,t=m.ENTRY_MODIFY,n=m.ENTRY_DELETE,u=m.OVERFLOW;return e.declare("rias.riass.WebServer",[e.ObjectBase,p],{debugLevel:e.host.debugLevel(),defaultLanguage:"zh",config:null,path:null,dbs:null,defaultDbName:"db/riastudio",defaultDb:null,create:function(a){this.appName=a.appName;delete a.appName;this.config=a||{};this.config.path||(this.config.path={});this.path||(this.path={});this.config.dbConfig||(this.config.dbConfig={});this.dbs={};this.config.defaultDbName&&(this.defaultDbName=this.config.defaultDbName);this.inherited(arguments)},hasRight:function(a,d,c){a=0;for(d=d.split("/").length;a<d;a++);return 1},encodeURI:function(a){return encodeURI(e.host.jsString(a))},decodeURI:function(a){return decodeURI(e.host.jsString(a))},isRequest:function(a){return!0},fetchByName:function(a,d,c){if(this.isRequest(a)){var g=this.getAttribute(a,d,c);return null==g?this.getParameter(a,d,c):g}return e.host.toType(a[d],c)},getParameter:function(a,d,c){d=a.getParameter(d);return null==d?null:e.host.toType(d,c||_typeStr)},getAttribute:function(a,d,c){d=a.getAttribute(d);return null==d?null:e.host.toType(d,c)},setAttribute:function(a,d,c){return a.setAttribute(d,c)},getAttributeNames:function(a){for(var d={},c,g=a.getAttributeNames();g.hasMoreElements();)c=e.host.jsString(g.nextElement()),d[c]=this.getAttribute(a,c);return d},getParameters:function(a){for(var d={},c,g=a.getParameterNames();g.hasMoreElements();)c=e.host.jsString(g.nextElement()),d[c]=this.getParameter(a,c);return d},getRequestURI:function(a){return this.decodeURI(a.getRequestURI())},getRequestURL:function(a){return this.decodeURI(a.getRequestURL())},getServletPath:function(a){return this.decodeURI(a.getServletPath())},getPathInfo:function(a){return this.decodeURI(a.getPathInfo())},getQueryString:function(a){return e.host.toString(a.getQueryString())},getMethod:function(a){return e.host.toString(a.getMethod())},response:function(a,d,c,g,b,f){try{e.host.response(d,c,g,b||void 0==b?e.mixin({min:this.config.respGzipMinSize,max:this.config.respGzipMaxSize},e.isObject(b)?b:{}):!1,f)}catch(l){e.host.response(d,this.responseCode.SC_INTERNAL_SERVER_ERROR,this.getRequestURL(a),!1,f),e.log(3,"WebServer",a,"Response error: "+l+"\n")}},responseCode:{SC_CONTINUE:b.SC_CONTINUE,SC_SWITCHING_PROTOCOLS:b.SC_SWITCHING_PROTOCOLS,SC_OK:b.SC_OK,SC_CREATED:b.SC_CREATED,SC_ACCEPTED:b.SC_ACCEPTED,SC_NON_AUTHORITATIVE_INFORMATION:b.SC_NON_AUTHORITATIVE_INFORMATION,SC_NO_CONTENT:b.SC_NO_CONTENT,SC_RESET_CONTENT:b.SC_RESET_CONTENT,SC_PARTIAL_CONTENT:b.SC_PARTIAL_CONTENT,SC_MULTIPLE_CHOICES:b.SC_MULTIPLE_CHOICES,SC_MOVED_PERMANENTLY:b.SC_MOVED_PERMANENTLY,SC_MOVED_TEMPORARILY:b.SC_MOVED_TEMPORARILY,SC_FOUND:b.SC_FOUND,SC_SEE_OTHER:b.SC_SEE_OTHER,SC_NOT_MODIFIED:b.SC_NOT_MODIFIED,SC_USE_PROXY:b.SC_USE_PROXY,SC_TEMPORARY_REDIRECT:b.SC_TEMPORARY_REDIRECT,SC_BAD_REQUEST:b.SC_BAD_REQUEST,SC_UNAUTHORIZED:b.SC_UNAUTHORIZED,SC_PAYMENT_REQUIRED:b.SC_PAYMENT_REQUIRED,SC_FORBIDDEN:b.SC_FORBIDDEN,SC_NOT_FOUND:b.SC_NOT_FOUND,SC_METHOD_NOT_ALLOWED:b.SC_METHOD_NOT_ALLOWED,SC_NOT_ACCEPTABLE:b.SC_NOT_ACCEPTABLE,SC_PROXY_AUTHENTICATION_REQUIRED:b.SC_PROXY_AUTHENTICATION_REQUIRED,SC_REQUEST_TIMEOUT:b.SC_REQUEST_TIMEOUT,SC_CONFLICT:b.SC_CONFLICT,SC_GONE:b.SC_GONE,SC_LENGTH_REQUIRED:b.SC_LENGTH_REQUIRED,SC_PRECONDITION_FAILED:b.SC_PRECONDITION_FAILED,SC_REQUEST_ENTITY_TOO_LARGE:b.SC_REQUEST_ENTITY_TOO_LARGE,SC_REQUEST_URI_TOO_LONG:b.SC_REQUEST_URI_TOO_LONG,SC_UNSUPPORTED_MEDIA_TYPE:b.SC_UNSUPPORTED_MEDIA_TYPE,SC_REQUESTED_RANGE_NOT_SATISFIABLE:b.SC_REQUESTED_RANGE_NOT_SATISFIABLE,SC_EXPECTATION_FAILED:b.SC_EXPECTATION_FAILED,SC_INTERNAL_SERVER_ERROR:b.SC_INTERNAL_SERVER_ERROR,SC_NOT_IMPLEMENTED:b.SC_NOT_IMPLEMENTED,SC_BAD_GATEWAY:b.SC_BAD_GATEWAY,SC_SERVICE_UNAVAILABLE:b.SC_SERVICE_UNAVAILABLE,SC_GATEWAY_TIMEOUT:b.SC_GATEWAY_TIMEOUT,SC_HTTP_VERSION_NOT_SUPPORTED:b.SC_HTTP_VERSION_NOT_SUPPORTED},getConditionSrv:function(a,d,c,e,b){return a?a.getCondition(d,c,e,b):this.defaultDb.getCondition(d,c,e,b)},getEqualStrSrv:function(a,d,c){return a?a.getEqualStr(d,c):this.defaultDb.getEqualStr(d,c)},getLikeStrSrv:function(a,d,c){return a?a.getLikeStr(d,c):this.defaultDb.getLikeStr(d,c)},getWhereSrv:function(a,d){return a?a.getWhere(d):this.defaultDb.getWhere(d)},getOrderBySrv:function(a,d,c){return a?a.getOrderBy(d,c):this.defaultDb.getOrderBy(d,c)},getLimitSrv:function(a,d,c){return a?a.getLimit(d,c):this.defaultDb.getLimit(d,c)},loadDbs:function(a){var d=this,c,b,h,f;for(c in a)if(a.hasOwnProperty(c)&&(b=a[c],e.isObjectSimple(b)))try{e.log(1,"WebServer","Setting DB Connection ..."+c),"mysql"==b.dbType&&e.require(["rias/riasdb/DbMySQL"],function(a){try{h=new a({server:d,dbType:b.dbType,dbConnName:c,dbConnConfig:b,defaultCatalog:b.defaultCatalog,maxResultRecords:b.maxResultRecords?b.maxResultRecords:999,afterGetDbDefine:function(a){try{f="serverApp/db/"+c.replace(/\\|\//,"_")+".json",d.writeJson(f,"serverApp",h.dbTables,{},!0),e.log(1,"WebServer","Save DB define in "+f)}catch(b){e.log(3,"WebServer","Save DB define Error: '"+c+"', "+b)}}}),d.dbs[c]=h,h.getDbDefine()}catch(k){e.log(3,"WebServer","Setting DB Connection Error: '"+c+"', "+k)}})}catch(l){e.log(3,"WebServer","Setting DB Connection Error: '"+c+"', "+l)}d.defaultDb=d.dbs[d.defaultDbName];d.defaultDb||e.log(2,"WebServer","There's no defaultDb: '"+d.defaultDbName+"'.")},startWebServer:function(a){throw Error("Unimplemented API: rias.riass.WebServer.startWebServer");},_monitorPath:{},monitor:function(a,d){function c(a){var d,k;a=e.host.jsString(a);a=b.convertFilePathName(a);try{a=e.host.newFile(a),d=a.toPath(),k=d.register(h,r,t,n),b._monitorPath[k]=d,e.forEach(a.listFiles(),function(a){a.directory&&c(a)})}catch(v){e.log(3,"FileMonitor","Add dir to monitor error: '"+a+"', \n"+v)}}var b=this,h=q.newWatchService();e.isString(a)?c(a):e.isArray(a)&&e.forEach(a,function(a){c(a)});e.host.newThread(function(){for(;;)try{var a=h.take(),c;e.forEach(e.host.jsArray(a.pollEvents()),function(e){c=e.kind();if(c!==u){var h=b._monitorPath[a];h&&d(h.resolve(e.context()),c)}});a.reset()}catch(k){e.log(3,"FileMonitor","FileMonitor Error: "+k+"\n"+k.javaException)}}).start()},startFileMonitor:function(a){function d(a,d){c._cacheAction&&c._cacheAction.remove(a);e.undef(a);e.log(1,"FileMonitor",'undef("'+a+'")');if(d)try{e.require([a],function(){e.log(1,"FileMonitor",'require(["'+a+'"]) ok.')})}catch(b){e.log(3,"FileMonitor",'require(["'+a+'"]) Error.\n'+b.javaExcception)}}var c=this;try{e.log(1,"FileMonitor","Starting FileMonitor ..."),c._monitorPath={},c.monitor(a,function(a,b){var f;try{f=c.getFilePathName(a+""),/\.js$/.test(f)&&(f=f.replace(/\.js$/,""),/riass\//.test(f)||(f=c.convertFilePathName(f,"",!0),e.require.modules[c.appName+"/"+f]&&d(c.appName+"/"+f,b!=n)))}catch(l){e.log(3,"FileMonitor","The FileMonitor Error: "+l+"\n"+l.javaException)}})}catch(b){e.log(3,"FileMonitor","Start FileMonitor Error: "+b+"\n"+b.javaException)}},start:function(){var a=this,b=this.path,c=this.config.path||{};try{e.log(1,"WebServer","Initialize WebServer ..."),a.debugLevel=e.host.debugLevel(),b.riasLib=a.getFilePathName(c.riasLib?c.riasLib:"jssrc/rias"),b.webLib=a.getFilePathName(c.webLib?c.webLib:"jssrc/webLib"),b.appRoot=a.getFilePathName(c.appRoot?c.appRoot:"jssrc/riasApp"),a._initPackagePath(),e.log(1,"WebServer","WebServer.path.appRoot is '"+b.appRoot+"'."),e.require(["dojo/i18n!"+a.appName+"/serverApp/nls/appi18n"],function(b){e.i18n[a.appName]=b}),a.loadDbs(a.config.dbConfig),a.startFileMonitor("serverApp/act"),a.startWebServer(a.config)}catch(g){e.log(3,"WebServer","Initialize WebServer Error: "+g+"\n"+g.javaException)}},stop:function(){},getSession:function(a){return null},getOper:function(a){return{}}})});