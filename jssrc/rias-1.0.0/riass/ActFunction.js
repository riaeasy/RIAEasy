define(["rias","rias/riass/ServerApp","rias/riass/logAct"],function(b,E,F){return function(f){var z;function G(u){var a;try{v=new Date;try{a=u.apply(c,[g,f])}finally{v=new Date-v}a?(b.mixin({},a),z=!0,b.isDebug&&(p=new Date,b.log(0,h,f,"response: ("+w.length+" B) - \u8017\u65f6\uff1a"+(p-x)+" \u6beb\u79d2\uff0c\u4ece"+b.formatDatetime(x,"HH:mm:ss:SSS")+" \u5230 "+b.formatDatetime(p,"HH:mm:ss:SSS")+"\n - result: "+(255>w.length?w:w.substring(0,250)+"...")))):b.log(3,h,b.substitute("ActFunction Error: ${0}, url: '${1}'.",["no result.",l])+"\n")}catch(q){b.log(3,h,b.substitute("ActFunction Error: ${0}, url: '${1}'.\n",[q,l]),q)}finally{}}function H(){p=new Date;var a=c.getParameters(f),e=c.getRemoteIp(f);120<e.length&&(e=e.substring(0,120)+"...");delete a._define;delete a._meta;delete a._rsfs;delete a._rsf;a=b.toJson(a);250<a.length&&(a=a.substring(0,250)+"...");b.isDebug&&b.log(0,h,f,"params: "+a);try{F.apply(c,[{serverid:c.getLocalPort(f),cat:d.appName,url:r,method:g,params:a,stat:z?1:0,dtcreate:x,opcreate:C?C:0,client:e,dms:p-x,dmsact:v}])}catch(q){b.log(3,h,"logAct error: "+l+"\n"+q,q)}}var x=new Date,p=0,v=0,d=this,A=d.actCache,c=d.apps.get(d.appName),h="actionEngine["+d.actiongEngineId+"] - "+d.appName;c||(b.synRequire([d.appName],function(a){c=b.safeMixin(new E({appConfig:d.appConfig,appName:d.appName,defaultDbName:d.appConfig.defaultDbName,dbs:d.dbs}),a)}),d.apps.put(d.appName,c));var l=c.getRequestURI(f),r=c.getServletPath(f)+c.getPathInfo(f),g=c.getMethod(f),a=c.getConditionSrv(0,f,"_method"),C=f["session.oper.id"],w="";c.caches={actCache:A,pageHtmlCache:d.pageHtmlCache,appModuleCache:d.appModuleCache};g&&(g=g.toUpperCase());a&&(a=a.toUpperCase());"GET"===g&&a&&(g=a);if("POST"===g)switch(a){case "DELETE":g="DELETE";break;case "PUT":g="PUT";break;default:a&&(g=a)}var B,k,e,a=[],m="",n,y,D,t;z=!1;try{if(r){B=c.actMapper[r.toLowerCase()]||{};if(B.filePath)k=B.filePath,a=k.split("/"),a[0].startWith("rias")||(m=c.appName+"/");else{e=r.split("/");if(3>e.length)throw"Invalid act path...";e[1].startWith("rias")?(a.push("rias"),"rias"!==e[1]&&a.push(e[1]),e.shift()):(m=c.appName+"/",a.push("serverApp"),a.push(e[1]));y=2;for(D=e.length;y<D;y++){n=e[y];if(/\s|\./.test(n))throw"Invalid act path...";""!==n&&"webApp"!==n&&"rias"!==n&&a.push(n)}k=a.join("/")}t=A.get(m+k);t||(b.log(0,h,f,"Loading... "+m+k),b.synRequire([m+k],function(a){t=a;A.put(m+k,a)}));t?G(t):b.log(3,h,b.substitute(b.i18n.message.notfound,[l])+"\n")}else b.log(2,h,b.substitute(b.i18n.message.notfound,[l])+"\n")}catch(u){b.log(3,h,b.substitute("ActFunction Error: ${0}, url: '${1}'.\n",[u,l]),u)}c.canDo_actLog(r,g)&&H();d.isRunning=!1}});