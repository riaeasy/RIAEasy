define(["rias/riass/hostRhino","rias/riasdb/DbBase"],function(f,r){var q=f.declare("rias.riasdb.DbMySQL",[r],{dbType:"mysql",postCreate:function(){this.dbType="mysql";this.inherited(arguments)},_closeStatement:function(a){if(a)try{a.close()}catch(b){}},_closeResultSet:function(a){if(a){var b;try{b=a.getStatement()}catch(c){}finally{try{a.close()}catch(c){}this._closeStatement(b)}}},afterGetDbDefine:function(a){},getDbDefine:function(a){a=a||this.defaultCatalog;var b="select *\nfrom information_schema.COLUMNS\nwhere TABLE_SCHEMA \x3d '"+a+"' and (TABLE_NAME like 'D%' or TABLE_NAME like 'x%')\norder by TABLE_NAME, ORDINAL_POSITION\n",c=[],d=null,e={},g={},k=this.fieldTypeType,h,l;try{this.dbTables=e;c=this.query1Array(b,{maxResultRecords:-1});c=c.data;h=0;for(l=c.length;h<l;h++)d=c[h],e[d.TABLE_NAME]||(e[d.TABLE_NAME]={}),e[d.TABLE_NAME][d.COLUMN_NAME]||(e[d.TABLE_NAME][d.COLUMN_NAME]={}),g=e[d.TABLE_NAME][d.COLUMN_NAME],g.ord=d.ORDINAL_POSITION,g.name=d.COLUMN_NAME,g.display=d.COLUMN_NAME,g.type=d.DATA_TYPE.toUpperCase(),g.typetype=k[g.type],g.length=d.CHARACTER_MAXIMUM_LENGTH||d.NUMERIC_PRECISION||d.DATETIME_PRECISION,g.scale=d.NUMERIC_SCALE,g["default"]=d.COLUMN_DEFAULT,g.nullable="YES"===d.IS_NULLABLE?1:0,g.searchable=""!==d.COLUMN_KEY,g.auto="auto_increment"===d.EXTRA?1:0,g.comment=d.COLUMN_COMMENT;this.afterGetDbDefine(e)}catch(m){this.dbTables=void 0,f.log(3,this.logName,"getDbDefine("+this.dbName+"."+a+") error:\n"+b),f.log(3,this.logName,"getDbDefine("+this.dbName+"."+a+") error:\n"+f.toJson(c)),f.log(3,this.logName,"getDbDefine("+this.dbName+"."+a+") error:\n"+m,m)}return this.dbTables},initConnection:function(){if(!this.dbName)throw Error("initConnection error: no dbName.");if(!this.dbConfig)throw Error("initConnection error: no dbConfig.");return f.host.dbInitConnection(this.dbName,this.dbConfig)},openConnection:function(){if(!this.dbName)throw Error("openConnection error: no dbName.");var a=this.initConnection(),a=a.getConnection();if(!this.dbTables)try{this.getDbDefine()}catch(b){f.log(3,this.logName,"The Connection getDbDefine Error: '"+this.dbName+"', "+b,b)}return a},closeConnection:function(a){if(a)try{if(!a.isClosed())try{a.getAutoCommit()||a.commit()}catch(b){a.rollback()}finally{a.close()}}catch(b){}},_beginTransaction:function(a,b){a.getAutoCommit()||a.commit();a.setAutoCommit(!1);b?"readUncommitted"==b?a.setTransactionIsolation(1):b.equals("readCommitted")?a.setTransactionIsolation(2):b.equals("repeatableRead")?a.setTransactionIsolation(4):b.equals("serializable")?a.setTransactionIsolation(8):a.setTransactionIsolation(2):a.setTransactionIsolation(2)},_endTransaction:function(a,b){try{b.success?a.commit():(f.log(3,this.logName,"Transaction error.",b.value),a.rollback())}catch(c){f.log(3,this.logName,"Transaction error.",c),a.rollback()}finally{a.setAutoCommit(!0)}},transaction:function(a,b){var c,d={success:!1,value:""};try{c=this.openConnection(),this._beginTransaction(c,b&&b.isolation),d=a(c),this._endTransaction(c,d),d.success?b&&f.isFunction(b.successCallback)&&b.successCallback(d):b&&f.isFunction(b.errorCallback)&&b.errorCallback(d)}catch(e){d={success:!1,value:"Transaction error."},this._endTransaction(c,d),f.log(3,this.logName,"Transaction error.",e),b&&f.isFunction(b.errorCallback)&&b.errorCallback(d,e)}finally{c&&this.closeConnection(c)}return d},transactionSqls:function(a,b){var c,d={success:!1,value:""};try{c=this.openConnection(),this._beginTransaction(c,b&&b.isolation),d=this._querySqls(c,a),this._endTransaction(c,d),d.success?b&&f.isFunction(b.successCallback)&&b.successCallback(d):b&&f.isFunction(b.errorCallback)&&b.errorCallback(d)}catch(e){d={success:!1,value:"Transaction error."},this._endTransaction(c,d),f.log(3,this.logName,"Transaction error.",e),b&&f.isFunction(b.errorCallback)&&b.errorCallback(d,e)}finally{c&&this.closeConnection(c)}return d},_getField:function(a,b,c,d,e,g){if(!a||!b)throw"Invalid arguments of _getField: [rs, fieldIndex]...";if(c)switch(c){case this.fieldTypeInt.CHAR:case this.fieldTypeInt.NCHAR:case this.fieldTypeInt.VARCHAR:case this.fieldTypeInt.NVARCHAR:e=g?('"'+f.host.jsString(a.getString(b)).replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r"):f.host.jsString(a.getString(b));break;case this.fieldTypeInt.INTEGER:e=g?f.host.jsString(a.getInt(b)):f.host.jsNumber(a.getInt(b));break;case this.fieldTypeInt.TINYINT:e=g?f.host.jsString(a.getByte(b)):f.host.jsNumber(a.getByte(b));break;case this.fieldTypeInt.SMALLINT:e=g?f.host.jsString(a.getShort(b)):f.host.jsNumber(a.getShort(b));break;case this.fieldTypeInt.BIGINT:e=g?f.host.jsString(a.getLong(b)):f.host.jsNumber(a.getLong(b));break;case this.fieldTypeInt.REAL:case this.fieldTypeInt.FLOAT:e=g?f.host.jsString(a.getFloat(b)):f.host.jsNumber(a.getFloat(b));break;case this.fieldTypeInt.DOUBLE:e=g?f.host.jsString(a.getDouble(b)):f.host.jsNumber(a.getDouble(b));break;case this.fieldTypeInt.DECIMAL:case this.fieldTypeInt.NUMERIC:e=g?f.host.jsString(a.getBigDecimal(b)):f.host.jsNumber(a.getBigDecimal(b));break;case this.fieldTypeInt.TIMESTAMP:case this.fieldTypeInt.DATE:if(e=a.getTimestamp(b))e=f.host.jsString(e).split(".")[0],e=new Date(e.replace(/\-/g,"/")),g&&(e='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=e["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.TIME:e=a.getTime(b);g&&(e='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=e["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.BOOLEAN:case this.fieldTypeInt.BIT:e=f.host.jsBoolean(a.getBoolean(b));e=g?f.host.jsBoolean(a.getBoolean(b))?"true":"false":f.host.jsBoolean(a.getBoolean(b));break;case this.fieldTypeInt.LONGVARCHAR:case this.fieldTypeInt.LONGNVARCHAR:case this.fieldTypeInt.CLOB:case this.fieldTypeInt.NCLOB:b=a.getCharacterStream(b);null==b?e=g?'""':"":(e=g?'"'+f.host.readStream(b).replace(/\"/g,'\\"')+'"':f.host.readStream(b),b.close());break;case this.fieldTypeInt.BLOB:case this.fieldTypeInt.BINARY:case this.fieldTypeInt.VARBINARY:case this.fieldTypeInt.LONGVARBINARY:b=a.getBinaryStream(b);void 0==d||null==d||1==!!d?null==b?e=g?'"(blob)"':"(blob)":(e=g?'"(BLOB)"':"(BLOB)",b.close()):null==b?e=g?'""':"":(e=g?'"'+f.host.readStream(b).replace(/\"/g,'\\"')+'"':f.host.readStream(b),b.close());break;default:e=g?'"'+a.getObject(b).toString().replace(/\"/g,'\\"')+'"':a.getObject(b)}else e=g?'"'+a.getObject(b).toString()+'"':a.getObject(b);return a.wasNull()?null:e},_resultsToArray:function(a,b,c){var d=[],e=[],g=a.getMetaData(),k=g.getColumnCount(),h=0,l=c||this.maxResultRecords;for(c=1;c<=k;c++)e.push([f.host.jsString(g.getColumnLabel(c)),g.getColumnType(c)]);for(;a.next()&&!(-1<l&&h>l);){g={};for(c=1;c<=k;c++)try{g[e[c-1][0]]=this._getField(a,c,e[c-1][1],b,void 0)}catch(m){throw f.log(3,this.logName,"_getField("+e[c-1][1]+") error - fieldname:"+e[c-1][0]+m.javaException,m),e[c-1][0]+": "+m;}d.push(g);h++}return{count:h,data:d}},_resultsToString:function(a,b,c){a=f.host.dbToJSONArray(a,f.toInt(c,this.maxResultRecords));return{count:a.length(),data:a.toString()}},_query:function(a,b,c,d){var e=0,g=0;f.isDebug&&(e=new Date);var k,h=null,l=null;d=d?d:"query";try{k=a.prepareStatement(b),h="query"==d?k.executeQuery():"update"==d?k.executeUpdate():k.execute()?k.getResultSet():1,"query"==d?l=c&&c.resultsToString?this._resultsToString(h,c&&c.ignoreBlob,c&&c.maxResultRecords):this._resultsToArray(h,c&&c.ignoreBlob,c&&c.maxResultRecords):"queryS"==d?l=this._resultsToString(h,c&&c.ignoreBlob,c&&c.maxResultRecords):"update"==d?l=f.host.jsNumber(h):"execute"==d&&(l=f.host.jsNumber(h)),f.isDebug&&(g=new Date,f.log(0,this.logName,"Executed... \n"+b+"\n\u8017\u65f6\uff1a"+(g-e)+" \u6beb\u79d2\uff0c\u4ece"+f.formatDatetime(e,"HH:mm:ss:SSS")+" \u5230 "+f.formatDatetime(g,"HH:mm:ss:SSS")+"\n"))}catch(m){f.log(3,this.logName,"Execute error... \n"+b,m);if(f.isDebug)throw m+"\n"+b;throw m;}finally{h instanceof java.sql.ResultSet&&this._closeResultSet(h)}return l},_querySqls:function(a,b,c){var d=0,e=0;f.isDebug&&(d=new Date);var g,k=null,h={success:!1,value:""},l=0,m,p;!f.isArray(b)&&(b=[b]);try{for(m=b.length;l<m;l++){p=b[l];try{g=a.prepareStatement(p),k=g.execute()?g.getResultSet():1,f.isDebug&&(e=new Date,f.log(0,this.logName,"Executed... \n"+p+"\n\u8017\u65f6\uff1a"+(e-d)+" \u6beb\u79d2\uff0c\u4ece"+f.formatDatetime(d,"HH:mm:ss:SSS")+" \u5230 "+f.formatDatetime(e,"HH:mm:ss:SSS")+"\n"))}catch(n){f.log(3,this.logName,"Execute error... \n"+n,n);if(f.isDebug)throw n+"\n"+p;throw n;}}h.success=!0;h.value=k}catch(n){k=null;h.success=!1;h.value="\u5904\u7406\u5931\u8d25...";f.log(3,this.logName,"Execute error... \n"+n,n);if(f.isDebug)throw n+"\n"+b;throw n;}finally{h.value=1==k?f.host.jsNumber(k):null==k?-1:c&&c.resultsToString?this._resultsToString(k,c&&c.ignoreBlob,c&&c.maxResultRecords):this._resultsToArray(k,c&&c.ignoreBlob,c&&c.maxResultRecords),k instanceof java.sql.ResultSet&&this._closeResultSet(k)}return h},getInsertSql:function(a){var b=this.dbTables[a.table],c,d,e,g,k=[],h=[],l=f.trim(a.where);for(c in a.values)if(b.hasOwnProperty(c)&&(d=b[c],!d.auto&&(g=d.typetype.toLowerCase(),e=a.values[c],"undefiend"!==e&&"blob"!==g))){if(null===e||"NaN"===e)e=d["default"]?"string"===g?"'"+d["default"]+"'":"date"===g?"'"+f.formatDatetime(d["default"],"yyyy/MM/dd HH:mm:ss")+"'":d["default"]:"null";else if(""===e)if("string"===g)e="''";else{if("int"===g||"decimal"===g||"float"===g||"boolean"===g)e=d["default"]?d["default"]:"null"}else"string"===g?e="'"+e.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'":"date"===g&&(e="'"+f.formatDatetime(e,"yyyy/MM/dd HH:mm:ss")+"'");k.push(c);h.push(e)}if(0<h.length)if(h.length===k.length)k="       ("+k.join(",")+")",h="values ("+h.join(",")+")";else throw"function insertRecord Error. The request parameter incorrect.";else h=k="";return"insert into "+a.table+"\n"+k+"\n"+h+"\n"+(l&&0<l.length?"where "+this.getWhere(l):"")},insertRecord:function(a){var b={success:!1,value:""},c;f.isString(a)?(c=a,a={sql:c}):c=a.sql||this.getInsertSql(a);b.success=0<this.execute1(c);b.args=a;return b},getDeleteSql:function(a){var b=f.trim(a.where),c=f.trim(a._idDirty),d="string"===this.dbTables[a.table].id.typetype;1===c.length?b.push({logic:"and",condition:d?" id \x3d '"+c[0]+"'":" id \x3d "+c[0]}):1<c.length&&b.push({logic:"and",condition:d?" id in ('"+c.join("','")+"')":" id in ("+c.join(",")+")"});if(1>b.length)throw"function deleteRecord Error. No 'where'.";return"delete from "+a.table+"\nwhere "+this.getWhere(b)},deleteRecord:function(a){var b={success:!1,value:""},c;f.isString(a)?(c=a,a={sql:c}):c=a.sql||this.getDeleteSql(a);b.success=0<this.execute1(c);b.args=a;return b},getUpdateSql:function(a){var b=this.dbTables[a.table],c,d,e,g,k=[],h=f.trim(a.where),l=f.trim(a._idDirty),m="string"===this.dbTables[a.table].id.typetype;for(c in a.sets)if(b.hasOwnProperty(c)&&"_idDirty"!==c&&!b[c].auto&&(d=b[c],g=d.typetype.toLowerCase(),e=a.sets[c],"undefiend"!==e&&"blob"!==g)){if(null===e||"NaN"===e)e=d["default"]?"string"===g?"'"+d["default"]+"'":"date"===g?"'"+f.formatDatetime(d["default"],"yyyy/MM/dd HH:mm:ss")+"'":d["default"]:"null";else if(""===e)if("string"===g)e="''";else{if("int"===g||"decimal"===g||"float"===g||"boolean"===g)e=d["default"]?d["default"]:"null"}else"string"===g?e="'"+e.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'":"date"===g&&(e="'"+f.formatDatetime(e,"yyyy/MM/dd HH:mm:ss")+"'");k.push(c+" \x3d "+e)}if(0<k.length)k="set "+k.join(",")+"";else throw"function updateRecord Error. No 'set'.";1===l.length?h.push({logic:"and",condition:m?" id \x3d '"+l[0]+"'":" id \x3d "+l[0]}):1<l.length&&h.push({logic:"and",condition:m?" id in ('"+l.join("','")+"')":" id in ("+l.join(",")+")"});if(1>h.length)throw"function updateRecord Error. No 'where'.";return"update "+a.table+" r\n"+k+" \nwhere "+this.getWhere(h)},updateRecord:function(a){var b={success:!1,value:""},c;f.isString(a)?(c=a,a={sql:c}):c=a.sql||this.getUpdateSql(a);b.success=0<=this.update1(c);b.args=a;return b},getQuerySql:function(a){var b,c,d,e,g,k;if(a.sql)a=a.sql;else{b="select "+(a.select?a.select:"*")+"\n";c="from "+a.from+"\n";d=f.trim(a.where);e=a.groupby?a.groupby+"\n":"";g=a.orderby?a.orderby+"\n":"";k=a.limit?a.limit:"";d=d&&0<d.length?"where "+this.getWhere(d)+"\n":"";if(!a.from||""===f.trim(a.from))throw"function queryPage Error. No 'from'.";a=b+c+d+e+g+k}return a},queryRecord:function(a){var b,c={success:!0,value:""};f.isString(a)?(b=a,a={sql:b}):b=a.sql||this.getQuerySql(a);b=a._queryOptions&&a._queryOptions.queryAsArray?this.query1Array(b,a._queryOptions):this.query1String(b,a._queryOptions);!a.limit&&b&&f.isNumber(b.count)&&(a.count=b.count,a.start=0,a.end=0<a.count?a.count-1:-1);c.value=b.data;c.args=a;return c},queryPage:function(a){var b,c,d,e,g,k,h,l={success:!0,value:""};if(a.sql)b=a.sql;else{b="select "+(a.select?a.select:"*")+"\n";c="from "+a.from+"\n";d=f.trim(a.where);e=a.groupby?a.groupby+"\n":"";g=a.orderby?a.orderby+"\n":"";k=a.limit?a.limit:"";d=d&&0<d.length?"where "+this.getWhere(d)+"\n":"";if(!a.from||""===f.trim(a.from))throw"function queryPage Error. No 'from'.";a.limit&&(h=this.query1Array("select count(*) as c_\nfrom (select 1 as c_\n"+c+d+e+") r",a._queryOptions),a.count=h&&0<h.count?h.data[0].c_:-1);b=b+c+d+e+g+k}h=a._queryOptions&&a._queryOptions.queryAsArray?this.query1Array(b,a._queryOptions):this.query1String(b,a._queryOptions);!a.limit&&h&&f.isNumber(h.count)&&(a.count=h.count,a.start=0,a.end=0<a.count?a.count-1:-1);l.value=h.data;l.args=a;return l},updateChildren:function(a){var b,c=f.trim(a.where),d={success:!1,value:""};b="set r.children \x3d (select count(*) from (select * from "+a.table+") as d where d.idp \x3d r.id)\n";c=c&&0<c.length?"where "+this.getWhere(c)+"\n":"";d.success=0<=this.update1("update "+a.table+" r\n"+b+c);d.args=a;return d}});q._riasdMeta={visual:!1,iconClass:"riaswDbMySQLIcon",iconClass16:"riaswDbMySQLIcon16",defaultParams:function(a){return f.mixinDeep({dbType:"mysql"},a)}};return q});