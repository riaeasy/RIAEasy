define(["rias/base/hostRhino","rias/riasdb/DbBase"],function(f,q){var p=f.declare("rias.riasdb.DbMySQL",[q],{dbType:"mysql",_closeStatement:function(b){if(b)try{b.close()}catch(c){}},_closeResultSet:function(b){if(b){var c;try{c=b.getStatement()}catch(a){}finally{try{b.close()}catch(a){}this._closeStatement(c)}}},afterGetDbDefine:function(b){},getDbDefine:function(b){b=b||this.defaultCatalog;b="select *\nfrom information_schema.COLUMNS\nwhere TABLE_SCHEMA \x3d '"+b+"' and (TABLE_NAME like 'D%' or TABLE_NAME like 'x%')\norder by TABLE_NAME, ORDINAL_POSITION\n";var c=[],a=null,e={},d={},g=this.fieldTypeType,k,h;try{this.dbTables=e;c=this.query1Array(b,{maxResultRecords:-1}).data;k=0;for(h=c.length;k<h;k++)a=c[k],e[a.TABLE_NAME]||(e[a.TABLE_NAME]={}),e[a.TABLE_NAME][a.COLUMN_NAME]||(e[a.TABLE_NAME][a.COLUMN_NAME]={}),d=e[a.TABLE_NAME][a.COLUMN_NAME],d.ord=a.ORDINAL_POSITION,d.name=a.COLUMN_NAME,d.display=a.COLUMN_NAME,d.type=a.DATA_TYPE.toUpperCase(),d.typetype=g[d.type],d.length=a.CHARACTER_MAXIMUM_LENGTH||a.NUMERIC_PRECISION||a.DATETIME_PRECISION,d.scale=a.NUMERIC_SCALE,d["default"]=a.COLUMN_DEFAULT,d.nullable="YES"===a.IS_NULLABLE?1:0,d.searchable=""!==a.COLUMN_KEY,d.auto="auto_increment"===a.EXTRA?1:0,d.comment=a.COLUMN_COMMENT;this.afterGetDbDefine(e)}catch(l){delete this.dbTables,f.log(3,"riasdb","getDbDefine("+this.dbConnName+"."+this.dbName+") error:\n"+l)}return this.dbTables},initConnection:function(){if(!this.dbConnConfig)throw Error("initConnection error: no dbConnConfig.");var b=new javax.naming.InitialContext,c,a=this.dbConnConfig;try{c=b.lookup(this.dbConnName)}catch(e){c=void 0}if(!c){if(!a)throw Error("Not found jndi: "+this.dbConnName+", no config.");c=new org.apache.commons.dbcp.BasicDataSource;c.setDriverClassName(a.driverClassName);c.setUrl(a.url);c.setUsername(a.username);c.setPassword(a.password);a.defaultCatalog&&c.setDefaultCatalog(a.defaultCatalog);a.validationQuery&&c.setValidationQuery(a.validationQuery);a.defaultReadOnly&&c.setDefaultReadOnly(a.defaultReadOnly);a.defaultAutoCommit&&c.setDefaultAutoCommit(a.defaultAutoCommit);a.initialSize&&c.setInitialSize(a.initialSize);a.maxActive&&c.setMaxActive(a.maxActive);a.maxIdle&&c.setMaxIdle(a.maxIdle);a.minIdle&&c.setMinIdle(a.minIdle);a.maxWait&&c.setMaxWait(a.maxWait);a.minEvictableIdleTimeMillis&&c.setMinEvictableIdleTimeMillis(a.minEvictableIdleTimeMillis);a.timeBetweenEvictionRunsMillis&&c.setTimeBetweenEvictionRunsMillis(a.timeBetweenEvictionRunsMillis);a.poolPreparedStatements&&c.setPoolPreparedStatements(a.poolPreparedStatements);a.maxOpenPreparedStatements&&c.setMaxOpenPreparedStatements(a.maxOpenPreparedStatements);a.logAbandoned&&c.setLogAbandoned(a.logAbandoned);a.removeAbandoned&&c.setRemoveAbandoned(a.removeAbandoned);a.removeAbandonedTimeout&&c.setRemoveAbandonedTimeout(a.removeAbandonedTimeout);a.testOnBorrow&&c.setTestOnBorrow(a.testOnBorrow);a.testOnReturn&&c.setTestOnReturn(a.testOnReturn);a.testWhileIdle&&c.setTestWhileIdle(a.testWhileIdle);new org.eclipse.jetty.plus.jndi.Resource(this.dbConnName,c);b.addToEnvironment(this.dbConnName,c);f.log(1,"riasdb","getConnection.init: "+this.dbConnName)}return c},openConnection:function(){if(!this.dbConnName)throw Error("openConnection error: no dbConnName.");var b=this.initConnection(),b=b.getConnection();if(!this.dbTables)try{this.getDbDefine()}catch(c){f.log(3,"server","The Connection getDbDefine Error: '"+connName+"', "+c)}return b},closeConnection:function(b,c){if(b)try{if(!b.isClosed())try{b.getAutoCommit()||(c?b.rollback():b.commit())}catch(a){b.rollback()}finally{b.close()}}catch(a){}},_beginTransaction:function(b,c){b.getAutoCommit()||b.commit();b.setAutoCommit(!1);c?"readUncommitted"==c?b.setTransactionIsolation(1):c.equals("readCommitted")?b.setTransactionIsolation(2):c.equals("repeatableRead")?b.setTransactionIsolation(4):c.equals("serializable")?b.setTransactionIsolation(8):b.setTransactionIsolation(2):b.setTransactionIsolation(2)},_endTransaction:function(b){},_setTransactionSuccessful:function(b){},transaction:function(b,c){var a,e=0;try{a=this.openConnection(),this._beginTransaction(a,c&&c.isolation),e=b(a),this._setTransactionSuccessful(a),this._endTransaction(a),c&&f.isFunction(c.successCallback)&&c.successCallback(e)}catch(d){e=0,f.log(3,"riasdb","Transaction error. \n"),c&&f.isFunction(c.errorCallback)&&c.errorCallback(d,e)}finally{a&&this.closeConnection(a)}return e},transactionSqls:function(b,c){var a,e=0;try{a=this.openConnection(),this._beginTransaction(a,c&&c.isolation),e=this._querySqls(a,b),this._setTransactionSuccessful(a),this._endTransaction(a),c&&f.isFunction(c.successCallback)&&c.successCallback(e)}catch(d){e=0,f.log(3,"riasdb","Transaction error. \n"),c&&f.isFunction(c.errorCallback)&&c.errorCallback(d,e)}finally{a&&this.closeConnection(a)}return e},_getField:function(b,c,a,e,d,g){if(!b||!c)throw"Invalid arguments of _getField: [rs, fieldIndex]...";if(a)switch(a){case this.fieldTypeInt.CHAR:case this.fieldTypeInt.NCHAR:case this.fieldTypeInt.VARCHAR:case this.fieldTypeInt.NVARCHAR:d=g?('"'+f.host.toString(b.getString(c)).replace(/(["\\])/g,"\\$1")+'"').replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r"):f.host.toString(b.getString(c));break;case this.fieldTypeInt.INTEGER:d=g?f.host.toString(b.getInt(c)):f.host.toNumber(b.getInt(c));break;case this.fieldTypeInt.TINYINT:d=g?f.host.toString(b.getByte(c)):f.host.toNumber(b.getByte(c));break;case this.fieldTypeInt.SMALLINT:d=g?f.host.toString(b.getShort(c)):f.host.toNumber(b.getShort(c));break;case this.fieldTypeInt.BIGINT:d=g?f.host.toString(b.getLong(c)):f.host.toNumber(b.getLong(c));break;case this.fieldTypeInt.REAL:case this.fieldTypeInt.FLOAT:d=g?f.host.toString(b.getFloat(c)):f.host.toNumber(b.getFloat(c));break;case this.fieldTypeInt.DOUBLE:d=g?f.host.toString(b.getDouble(c)):f.host.toNumber(b.getDouble(c));break;case this.fieldTypeInt.DECIMAL:case this.fieldTypeInt.NUMERIC:d=g?f.host.toString(b.getBigDecimal(c)):f.host.toNumber(b.getBigDecimal(c));break;case this.fieldTypeInt.TIMESTAMP:case this.fieldTypeInt.DATE:if(d=b.getTimestamp(c))d=f.host.toString(d).split(".")[0],d=new Date(d.replace(/\-/g,"/")),g&&(d='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=d["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.TIME:d=b.getTime(c);g&&(d='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=d["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.BOOLEAN:case this.fieldTypeInt.BIT:d=f.host.toBoolean(b.getBoolean(c));d=g?f.host.toBoolean(b.getBoolean(c))?"true":"false":f.host.toBoolean(b.getBoolean(c));break;case this.fieldTypeInt.LONGVARCHAR:case this.fieldTypeInt.LONGNVARCHAR:case this.fieldTypeInt.CLOB:case this.fieldTypeInt.NCLOB:c=b.getCharacterStream(c);null==c?d=g?'""':"":(d=g?'"'+f.host.readStream(c).replace(/\"/g,'\\"')+'"':f.host.readStream(c),c.close());break;case this.fieldTypeInt.BLOB:case this.fieldTypeInt.BINARY:case this.fieldTypeInt.VARBINARY:case this.fieldTypeInt.LONGVARBINARY:c=b.getBinaryStream(c);void 0==e||null==e||1==!!e?null==c?d=g?'"(blob)"':"(blob)":(d=g?'"(BLOB)"':"(BLOB)",c.close()):null==c?d=g?'""':"":(d=g?'"'+f.host.readStream(c).replace(/\"/g,'\\"')+'"':f.host.readStream(c),c.close());break;default:d=g?'"'+b.getObject(c).toString().replace(/\"/g,'\\"')+'"':b.getObject(c)}else d=g?'"'+b.getObject(c).toString()+'"':b.getObject(c);return b.wasNull()?null:d},_getFieldByName:function(b,c,a,e,d,f){return this._getField(b,b.findColumn(c),a,e,d,f)},_resultToObject:function(b,c){var a={},e=b.getMetaData(),d,g=e.getColumnCount();for(d=1;d<=g;d++)a[f.host.jsString(e.getColumnLabel(d))]=this._getField(b,d,e.getColumnType(d),c,void 0);return a},_resultsToArray:function(b,c,a){var e=[],d=[],g=b.getMetaData(),k=g.getColumnCount(),h=0,l=a||this.maxResultRecords;for(a=1;a<=k;a++)d.push([f.host.jsString(g.getColumnLabel(a)),g.getColumnType(a)]);for(;b.next()&&!(-1<l&&h>l);){g={};for(a=1;a<=k;a++)try{g[d[a-1][0]]=this._getField(b,a,d[a-1][1],c,void 0)}catch(m){throw f.log(3,"riasdb","_getField("+d[a-1][1]+") error - fieldname:"+d[a-1][0]+m.javaException),d[a-1][0]+": "+m;}e.push(g);h++}return{count:h,data:e}},_resultsToString:function(b,c,a){var e="[",d=[],g=b.getMetaData(),k=g.getColumnCount(),h,l=0,m=a||this.maxResultRecords;for(a=1;a<=k;a++)d.push([f.host.jsString(g.getColumnLabel(a)),g.getColumnType(a)]);for(;b.next()&&!(-1<m&&l>m);){e+=l?",{":"{";for(a=1;a<=k;a++)try{(h=this._getField(b,a,d[a-1][1],c,h,!0))&&null!=h||(h="null"),e+='"'+d[a-1][0]+'":'+h+(a<k?",":"")}catch(n){throw f.log(3,"riasdb","_getField error, fields["+a+"]("+d[a-1][0]+") error:"+n.javaException),d[a-1][0]+": "+n;}e+="}";l++}return{count:l,data:e+"]"}},_query:function(b,c,a,e){var d=0,g=0;f.isDebug&&(d=new Date);var k,h=null,l=null;e=e?e:"query";try{k=b.prepareStatement(c),h="query"==e?k.executeQuery():"update"==e?k.executeUpdate():k.execute()?k.getResultSet():1,"query"==e?l=a&&a.resultsToString?this._resultsToString(h,a&&a.ignoreBlob,a&&a.maxResultRecords):this._resultsToArray(h,a&&a.ignoreBlob,a&&a.maxResultRecords):"queryS"==e?l=this._resultsToString(h,a&&a.ignoreBlob,a&&a.maxResultRecords):"update"==e?l=f.host.jsNumber(h):"execute"==e&&(l=f.host.jsNumber(h)),f.isDebug&&(g=new Date,f.log(0,"riasdb","Executed... \n"+c+"\n\u8017\u65f6\uff1a"+(g-d)+" \u6beb\u79d2\uff0c\u4ece"+f.datetime.format(d,"HH:mm:ss:SSS")+" \u5230 "+f.datetime.format(g,"HH:mm:ss:SSS")+"\n"))}catch(m){f.log(3,"riasdb","Execute error... \n"+c+"\n");if(f.isDebug)throw m+"\n"+c;throw m;}finally{h instanceof java.sql.ResultSet&&this._closeResultSet(h)}return l},_querySqls:function(b,c,a){var e=0,d=0;f.isDebug&&(e=new Date);var g,k=null,h=null,h=0,l,m;!f.isArray(c)&&(c=[c]);try{for(l=c.length;h<l;h++)m=c[h],g=b.prepareStatement(m),k=g.execute()?g.getResultSet():1,f.isDebug&&(d=new Date,f.log(0,"riasdb","Executed... \n"+m+"\n\u8017\u65f6\uff1a"+(d-e)+" \u6beb\u79d2\uff0c\u4ece"+f.datetime.format(e,"HH:mm:ss:SSS")+" \u5230 "+f.datetime.format(d,"HH:mm:ss:SSS")+"\n"))}catch(n){k=null;f.log(3,"riasdb","Execute error... \n"+m+"\n");if(f.isDebug)throw n+"\n"+m;throw n;}finally{h=1==k?f.host.jsNumber(k):null==k?-1:a&&a.resultsToString?this._resultsToString(k,a&&a.ignoreBlob,a&&a.maxResultRecords):this._resultsToArray(k,a&&a.ignoreBlob,a&&a.maxResultRecords),k instanceof java.sql.ResultSet&&this._closeResultSet(k)}return h},getInsertSql:function(b){var c=this.dbTables[b.table],a,e,d=null,g="",k=[],h=[],l=f.trim(b.where);e="";for(a in b.values)if(c.hasOwnProperty(a)&&(e=c[a],!e.auto&&(g=e.typetype.toLowerCase(),d=b.values[a],"undefiend"!==d&&"blob"!==g))){if(null===d||"NaN"===d)d=e["default"]?"string"===g?"'"+e["default"]+"'":"date"===g?"'"+f.datetime.format(e["default"],"yyyy-MM-dd HH:mm:ss")+"'":e["default"]:"null";else if(""===d)if("string"===g)d="''";else{if("int"===g||"decimal"===g||"float"===g||"boolean"===g)d=e["default"]?e["default"]:"null"}else"string"===g?d="'"+d+"'":"date"===g&&(d="'"+f.datetime.format(d,"yyyy-MM-dd HH:mm:ss")+"'");k.push(a);h.push(d)}if(0<h.length)if(h.length===k.length)k="       ("+k.join(",")+")",h="values ("+h.join(",")+")";else throw"function insertRecord Error. The request parameter incorrect.";else h=k="";return e="insert into "+b.table+"\n"+k+"\n"+h+"\n"+(l&&0<l.length?"where "+this.getWhere(l):"")},insertRecord:function(b){var c={success:!1,value:""},a=b.sql||this.getInsertSql(b);c.success=0<this.execute1(a);c.args=b;return c},getDeleteSql:function(b){var c=f.trim(b.where),a=f.trim(b._idDirty),e="string"===this.dbTables[b.table].id.typetype,d="";1===a.length?c.push({logic:"and",condition:e?" id \x3d '"+a[0]+"'":" id \x3d "+a[0]}):1<a.length&&c.push({logic:"and",condition:e?" id in ('"+a.join("','")+"')":" id in ("+a.join(",")+")"});if(1>c.length)throw"function deleteRecord Error. No 'where'.";return d="delete from "+b.table+"\nwhere "+this.getWhere(c)},deleteRecord:function(b){var c={success:!1,value:""},a=b.sql||this.getDeleteSql(b);c.success=0<this.execute1(a);c.args=b;return c},getUpdateSql:function(b){var c=this.dbTables[b.table],a,e,d=null,g="",k=[],h=f.trim(b.where),l=f.trim(b._idDirty),m="string"===this.dbTables[b.table].id.typetype;for(a in b.sets)if(c.hasOwnProperty(a)&&"_idDirty"!==a&&!c[a].auto&&(e=c[a],g=e.typetype.toLowerCase(),d=b.sets[a],"undefiend"!==d&&"blob"!==g)){if(null===d||"NaN"===d)d=e["default"]?"string"===g?"'"+e["default"]+"'":"date"===g?"'"+f.datetime.format(e["default"],"yyyy-MM-dd HH:mm:ss")+"'":e["default"]:"null";else if(""===d)if("string"===g)d="''";else{if("int"===g||"decimal"===g||"float"===g||"boolean"===g)d=e["default"]?e["default"]:"null"}else"string"===g?d="'"+d+"'":"date"===g&&(d="'"+f.datetime.format(d,"yyyy-MM-dd HH:mm:ss")+"'");k.push(a+" \x3d "+d)}if(0<k.length)k="set "+k.join(",")+"";else throw"function updateRecord Error. No 'set'.";1===l.length?h.push({logic:"and",condition:m?" id \x3d '"+l[0]+"'":" id \x3d "+l[0]}):1<l.length&&h.push({logic:"and",condition:m?" id in ('"+l.join("','")+"')":" id in ("+l.join(",")+")"});if(1>h.length)throw"function updateRecord Error. No 'where'.";return"update "+b.table+" r\n"+k+" \nwhere "+this.getWhere(h)},updateRecord:function(b){var c={success:!1,value:""},a=b.sql||this.getUpdateSql(b);c.success=0<=this.update1(a);c.args=b;return c},getQuerySql:function(b){var c="",a="",e=[],d="",g="",k="",c="";if(b.sql)c=b.sql;else{c="select "+(b.select?b.select:"*")+"\n";a="from "+b.from+"\n";e=f.trim(b.where);d=b.groupby?b.groupby+"\n":"";g=b.orderby?b.orderby+"\n":"";k=b.limit?b.limit:"";e=e&&0<e.length?"where "+this.getWhere(e)+"\n":"";if(!b.from||""===f.trim(b.from))throw"function queryPage Error. No 'from'.";c=c+a+e+d+g+k}return c},queryRecord:function(b){var c=null,a={success:!0,value:""},c=b.sql||this.getQuerySql(b),c=b._queryOptions&&b._queryOptions.queryAsArray?this.query1Array(c,b._queryOptions):this.query1String(c,b._queryOptions);!b.limit&&c&&f.isNumber(c.count)&&(b.count=c.count,b.start=0,b.end=0<b.count?b.count-1:-1);a.value=c.data;a.args=b;return a},queryPage:function(b){var c="",a="",e=[],d="",g="",k="",c="",h=null,l={success:!0,value:""};if(b.sql)c=b.sql;else{c="select "+(b.select?b.select:"*")+"\n";a="from "+b.from+"\n";e=f.trim(b.where);d=b.groupby?b.groupby+"\n":"";g=b.orderby?b.orderby+"\n":"";k=b.limit?b.limit:"";e=e&&0<e.length?"where "+this.getWhere(e)+"\n":"";if(!b.from||""===f.trim(b.from))throw"function queryPage Error. No 'from'.";b.limit&&(h=this.query1Array("select count(*) as c_\nfrom (select 1 as c_\n"+a+e+d+") r",b._queryOptions),b.count=h&&0<h.count?h.data[0].c_:-1);c=c+a+e+d+g+k}h=b._queryOptions&&b._queryOptions.queryAsArray?this.query1Array(c,b._queryOptions):this.query1String(c,b._queryOptions);!b.limit&&h&&f.isNumber(h.count)&&(b.count=h.count,b.start=0,b.end=0<b.count?b.count-1:-1);l.value=h.data;l.args=b;return l},updateChildren:function(b){var c,a=f.trim(b.where);c="";var e={success:!1,value:""};c="set r.children \x3d (select count(*) from (select * from "+b.table+") as d where d.idp \x3d r.id)\n";a=a&&0<a.length?"where "+this.getWhere(a)+"\n":"";c="update "+b.table+" r\n"+c+a;e.success=0<=this.update1(c);e.args=b;return e}});p._riasdMeta={visual:!1,iconClass:"riaswDbMySQLIcon",iconClass16:"riaswDbMySQLIcon16",defaultParams:function(b){return f.mixinDeep({dbType:"mysql"},b)}};return p});