define(["rias/base/hostRhino","rias/riasdb/DbBase"],function(f,q){var p=f.declare("rias.riasdb.DbMySQL",[q],{dbType:"mysql",_closeStatement:function(c){if(c)try{c.close()}catch(b){}},_closeResultSet:function(c){if(c){var b;try{b=c.getStatement()}catch(a){}finally{try{c.close()}catch(e){}this._closeStatement(b)}}},afterGetDbDefine:function(c){},getDbDefine:function(c){c=c||this.defaultCatalog;c="select *\nfrom information_schema.COLUMNS\nwhere TABLE_SCHEMA \x3d '"+c+"' and (TABLE_NAME like 'D%' or TABLE_NAME like 'x%')\norder by TABLE_NAME, ORDINAL_POSITION\n";var b=[],a=null,e={},d={},g=this.fieldTypeType,k,h;try{this.dbTables=e;b=this.query1Array(c,{maxResultRecords:-1}).data;k=0;for(h=b.length;k<h;k++)a=b[k],e[a.TABLE_NAME]||(e[a.TABLE_NAME]={}),e[a.TABLE_NAME][a.COLUMN_NAME]||(e[a.TABLE_NAME][a.COLUMN_NAME]={}),d=e[a.TABLE_NAME][a.COLUMN_NAME],d.ord=a.ORDINAL_POSITION,d.name=a.COLUMN_NAME,d.display=a.COLUMN_NAME,d.type=a.DATA_TYPE.toUpperCase(),d.typetype=g[d.type],d.length=a.CHARACTER_MAXIMUM_LENGTH||a.NUMERIC_PRECISION||a.DATETIME_PRECISION,d.scale=a.NUMERIC_SCALE,d["default"]=a.COLUMN_DEFAULT,d.nullable="YES"===a.IS_NULLABLE?1:0,d.searchable=""!==a.COLUMN_KEY,d.auto="auto_increment"===a.EXTRA?1:0,d.comment=a.COLUMN_COMMENT;this.afterGetDbDefine(e)}catch(l){delete this.dbTables,f.log(3,"riasdb","getDbDefine("+this.dbConnName+"."+this.dbName+") error:\n"+l)}return this.dbTables},initConnection:function(){if(!this.dbConnConfig)throw Error("initConnection error: no dbConnConfig.");var c=new javax.naming.InitialContext,b,a=this.dbConnConfig;try{b=c.lookup(this.dbConnName)}catch(e){b=void 0}if(!b){if(!a)throw Error("Not found jndi: "+this.dbConnName+", no config.");b=new org.apache.commons.dbcp.BasicDataSource;b.setDriverClassName(a.driverClassName);b.setUrl(a.url);b.setUsername(a.username);b.setPassword(a.password);a.defaultCatalog&&b.setDefaultCatalog(a.defaultCatalog);a.validationQuery&&b.setValidationQuery(a.validationQuery);a.defaultReadOnly&&b.setDefaultReadOnly(a.defaultReadOnly);a.defaultAutoCommit&&b.setDefaultAutoCommit(a.defaultAutoCommit);a.initialSize&&b.setInitialSize(a.initialSize);a.maxActive&&b.setMaxActive(a.maxActive);a.maxIdle&&b.setMaxIdle(a.maxIdle);a.minIdle&&b.setMinIdle(a.minIdle);a.maxWait&&b.setMaxWait(a.maxWait);a.minEvictableIdleTimeMillis&&b.setMinEvictableIdleTimeMillis(a.minEvictableIdleTimeMillis);a.timeBetweenEvictionRunsMillis&&b.setTimeBetweenEvictionRunsMillis(a.timeBetweenEvictionRunsMillis);a.poolPreparedStatements&&b.setPoolPreparedStatements(a.poolPreparedStatements);a.maxOpenPreparedStatements&&b.setMaxOpenPreparedStatements(a.maxOpenPreparedStatements);a.logAbandoned&&b.setLogAbandoned(a.logAbandoned);a.removeAbandoned&&b.setRemoveAbandoned(a.removeAbandoned);a.removeAbandonedTimeout&&b.setRemoveAbandonedTimeout(a.removeAbandonedTimeout);a.testOnBorrow&&b.setTestOnBorrow(a.testOnBorrow);a.testOnReturn&&b.setTestOnReturn(a.testOnReturn);a.testWhileIdle&&b.setTestWhileIdle(a.testWhileIdle);new org.eclipse.jetty.plus.jndi.Resource(this.dbConnName,b);c.addToEnvironment(this.dbConnName,b);f.log(1,"riasdb","getConnection.init: "+this.dbConnName)}return b},openConnection:function(){if(!this.dbConnName)throw Error("openConnection error: no dbConnName.");var c=this.initConnection(),c=c.getConnection();if(!this.dbTables)try{this.getDbDefine()}catch(b){f.log(3,"server","The Connection getDbDefine Error: '"+connName+"', "+b)}return c},closeConnection:function(c,b){if(c)try{if(!c.isClosed())try{c.getAutoCommit()||(b?c.rollback():c.commit())}catch(a){c.rollback()}finally{c.close()}}catch(e){}},_beginTransaction:function(c,b){c.getAutoCommit()||c.commit();c.setAutoCommit(!1);b?"readUncommitted"==b?c.setTransactionIsolation(1):b.equals("readCommitted")?c.setTransactionIsolation(2):b.equals("repeatableRead")?c.setTransactionIsolation(4):b.equals("serializable")?c.setTransactionIsolation(8):c.setTransactionIsolation(2):c.setTransactionIsolation(2)},_endTransaction:function(c){},_setTransactionSuccessful:function(c){},transaction:function(c,b){var a,e=0;try{a=this.openConnection(),this._beginTransaction(a,b&&b.isolation),e=c(a),this._setTransactionSuccessful(a),this._endTransaction(a),b&&f.isFunction(b.successCallback)&&b.successCallback(e)}catch(d){e=0,f.log(3,"riasdb","Transaction error. \n"),b&&f.isFunction(b.errorCallback)&&b.errorCallback(d,e)}finally{a&&this.closeConnection(a)}return e},transactionSqls:function(c,b){var a,e=0;try{a=this.openConnection(),this._beginTransaction(a,b&&b.isolation),e=this._querySqls(a,c),this._setTransactionSuccessful(a),this._endTransaction(a),b&&f.isFunction(b.successCallback)&&b.successCallback(e)}catch(d){e=0,f.log(3,"riasdb","Transaction error. \n"),b&&f.isFunction(b.errorCallback)&&b.errorCallback(d,e)}finally{a&&this.closeConnection(a)}return e},_getField:function(c,b,a,e,d,g){if(!c||!b)throw"Invalid arguments of _getField: [rs, fieldIndex]...";if(a)switch(a){case this.fieldTypeInt.CHAR:case this.fieldTypeInt.NCHAR:case this.fieldTypeInt.VARCHAR:case this.fieldTypeInt.NVARCHAR:d=g?'"'+f.host.toString(c.getString(b))+'"':f.host.toString(c.getString(b));break;case this.fieldTypeInt.INTEGER:d=g?f.host.toString(c.getInt(b)):f.host.toNumber(c.getInt(b));break;case this.fieldTypeInt.TINYINT:d=g?f.host.toString(c.getByte(b)):f.host.toNumber(c.getByte(b));break;case this.fieldTypeInt.SMALLINT:d=g?f.host.toString(c.getShort(b)):f.host.toNumber(c.getShort(b));break;case this.fieldTypeInt.BIGINT:d=g?f.host.toString(c.getLong(b)):f.host.toNumber(c.getLong(b));break;case this.fieldTypeInt.REAL:case this.fieldTypeInt.FLOAT:d=g?f.host.toString(c.getFloat(b)):f.host.toNumber(c.getFloat(b));break;case this.fieldTypeInt.DOUBLE:d=g?f.host.toString(c.getDouble(b)):f.host.toNumber(c.getDouble(b));break;case this.fieldTypeInt.DECIMAL:case this.fieldTypeInt.NUMERIC:d=g?f.host.toString(c.getBigDecimal(b)):f.host.toNumber(c.getBigDecimal(b));break;case this.fieldTypeInt.TIMESTAMP:case this.fieldTypeInt.DATE:if(d=c.getTimestamp(b))d=f.host.toString(d).split(".")[0],d=new Date(d.replace(/\-/g,"/")),g&&(d='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=d["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.TIME:d=c.getTime(b);g&&(d='"{FullYear}-{Month+}-{Date}T{Hours}:{Minutes}:{Seconds}Z"'.replace(/\{(\w+)(\+)?\}/g,function(a,b,c){a=d["getUTC"+b]()+(c?1:0);return 10>a?"0"+a:a}));break;case this.fieldTypeInt.BOOLEAN:case this.fieldTypeInt.BIT:d=f.host.toBoolean(c.getBoolean(b));d=g?f.host.toBoolean(c.getBoolean(b))?"true":"false":f.host.toBoolean(c.getBoolean(b));break;case this.fieldTypeInt.LONGVARCHAR:case this.fieldTypeInt.LONGNVARCHAR:case this.fieldTypeInt.CLOB:case this.fieldTypeInt.NCLOB:b=c.getCharacterStream(b);null==b?d=g?'""':"":(d=g?'"'+f.host.readStream(b)+'"':f.host.readStream(b),b.close());break;case this.fieldTypeInt.BLOB:case this.fieldTypeInt.BINARY:case this.fieldTypeInt.VARBINARY:case this.fieldTypeInt.LONGVARBINARY:b=c.getBinaryStream(b);void 0==e||null==e||1==!!e?null==b?d=g?'"(blob)"':"(blob)":(d=g?'"(BLOB)"':"(BLOB)",b.close()):null==b?d=g?'""':"":(d=g?'"'+f.host.readStream(b)+'"':f.host.readStream(b),b.close());break;default:d=g?'"'+c.getObject(b).toString()+'"':c.getObject(b)}else d=g?'"'+c.getObject(b).toString()+'"':c.getObject(b);return c.wasNull()?null:d},_getFieldByName:function(c,b,a,e,d,f){return this._getField(c,c.findColumn(b),a,e,d,f)},_resultToObject:function(c,b){var a={},e=c.getMetaData(),d,g=e.getColumnCount();for(d=1;d<=g;d++)a[f.host.jsString(e.getColumnLabel(d))]=this._getField(c,d,e.getColumnType(d),b,void 0);return a},_resultsToArray:function(c,b,a){var e=[],d=[],g=c.getMetaData(),k=g.getColumnCount(),h=0,l=a||this.maxResultRecords;for(a=1;a<=k;a++)d.push([f.host.jsString(g.getColumnLabel(a)),g.getColumnType(a)]);for(;c.next()&&!(-1<l&&h>l);){g={};for(a=1;a<=k;a++)try{g[d[a-1][0]]=this._getField(c,a,d[a-1][1],b,void 0)}catch(m){throw f.log(3,"riasdb","_getField("+d[a-1][1]+") error - fieldname:"+d[a-1][0]+m.javaException),d[a-1][0]+": "+m;}e.push(g);h++}return{count:h,data:e}},_resultsToString:function(c,b,a){var e="[",d=[],g=c.getMetaData(),k=g.getColumnCount(),h,l=0,m=a||this.maxResultRecords;for(a=1;a<=k;a++)d.push([f.host.jsString(g.getColumnLabel(a)),g.getColumnType(a)]);for(;c.next()&&!(-1<m&&l>m);){e+=l?",{":"{";for(a=1;a<=k;a++)try{(h=this._getField(c,a,d[a-1][1],b,h,!0))&&null!=h||(h="null"),e+='"'+d[a-1][0]+'":'+h+(a<k?",":"")}catch(n){throw f.log(3,"riasdb","_getField error, fields["+a+"]("+d[a-1][0]+") error:"+n.javaException),d[a-1][0]+": "+n;}e+="}";l++}return{count:l,data:e+"]"}},_query:function(c,b,a,e){var d=0,g=0;f.isDebug&&(d=new Date);var k,h=null,l=null;e=e?e:"query";try{k=c.prepareStatement(b),h="query"==e?k.executeQuery():"update"==e?k.executeUpdate():k.execute()?k.getResultSet():1,"query"==e?l=a&&a.resultsToString?this._resultsToString(h,a&&a.ignoreBlob,a&&a.maxResultRecords):this._resultsToArray(h,a&&a.ignoreBlob,a&&a.maxResultRecords):"queryS"==e?l=this._resultsToString(h,a&&a.ignoreBlob,a&&a.maxResultRecords):"update"==e?l=f.host.jsNumber(h):"execute"==e&&(l=f.host.jsNumber(h)),f.isDebug&&(g=new Date,f.log(0,"riasdb","Executed... \n"+b+"\n\u8017\u65f6\uff1a"+(g-d)+" \u6beb\u79d2\uff0c\u4ece"+f.datetime.format(d,"HH:mm:ss:SSS")+" \u5230 "+f.datetime.format(g,"HH:mm:ss:SSS")+"\n"))}catch(m){f.log(3,"riasdb","Execute error... \n"+b+"\n");if(f.isDebug)throw m+"\n"+b;throw m;}finally{h instanceof java.sql.ResultSet&&this._closeResultSet(h)}return l},_querySqls:function(c,b,a){var e=0,d=0;f.isDebug&&(e=new Date);var g,k=null,h=null,h=0,l,m;!f.isArray(b)&&(b=[b]);try{for(l=b.length;h<l;h++)m=b[h],g=c.prepareStatement(m),k=g.execute()?g.getResultSet():1,f.isDebug&&(d=new Date,f.log(0,"riasdb","Executed... \n"+m+"\n\u8017\u65f6\uff1a"+(d-e)+" \u6beb\u79d2\uff0c\u4ece"+f.datetime.format(e,"HH:mm:ss:SSS")+" \u5230 "+f.datetime.format(d,"HH:mm:ss:SSS")+"\n"))}catch(n){k=null;f.log(3,"riasdb","Execute error... \n"+m+"\n");if(f.isDebug)throw n+"\n"+m;throw n;}finally{h=1==k?f.host.jsNumber(k):null==k?-1:a&&a.resultsToString?this._resultsToString(k,a&&a.ignoreBlob,a&&a.maxResultRecords):this._resultsToArray(k,a&&a.ignoreBlob,a&&a.maxResultRecords),k instanceof java.sql.ResultSet&&this._closeResultSet(k)}return h},getInsertSql:function(c){var b=this.dbTables[c.table],a,e=null,d="",g=[],k=[],h=f.trim(c.where),e="";for(a in c.values)if(b.hasOwnProperty(a)&&!b[a].auto&&(d=b[a].typetype.toLowerCase(),e=c.values[a],"undefiend"!==e&&"blob"!==d)){if(null===e)e="string"===d||"clob"===d?"'"+b[a]["default"]+"'":b[a]["default"];else if(""===e)if("string"===d||"clob"===d)e="'"+b[a]["default"]+"'";else{if("int"===d||"float"===d||"date"===d||"bool"===d)e=b[a]["default"]}else"string"===d||"clob"===d?e="'"+e+"'":"date"===d&&(e="'"+f.datetime.format(e,"yyyy-MM-dd HH:mm:ss")+"'");g.push(a);k.push(e)}if(0<k.length)if(k.length===g.length)g="       ("+g.join(",")+")",k="values ("+k.join(",")+")";else throw"function insertRecord Error. The request parameter incorrect.";else k=g="";return e="insert into "+c.table+"\n"+g+"\n"+k+"\n"+(h&&0<h.length?"where "+this.getWhere(h):"")},insertRecord:function(c){var b={success:!1,value:""},a=c.sql||this.getInsertSql(c);b.success=0<this.execute1(a);b.args=c;return b},getDeleteSql:function(c){var b=f.trim(c.where),a=f.trim(c._idDirty),e="string"===this.dbTables[c.table].id.typetype,d="";1===a.length?b.push({logic:"and",condition:e?" id \x3d '"+a[0]+"'":" id \x3d "+a[0]}):1<a.length&&b.push({logic:"and",condition:e?" id in ('"+a.join("','")+"')":" id in ("+a.join(",")+")"});if(1>b.length)throw"function deleteRecord Error. No 'where'.";return d="delete from "+c.table+"\nwhere "+this.getWhere(b)},deleteRecord:function(c){var b={success:!1,value:""},a=c.sql||this.getDeleteSql(c);b.success=0<this.execute1(a);b.args=c;return b},getUpdateSql:function(c){var b=this.dbTables[c.table],a,e=null,d="",g=[],k=f.trim(c.where),h=f.trim(c._idDirty),l="string"===this.dbTables[c.table].id.typetype;for(a in c.sets)if(b.hasOwnProperty(a)&&"_idDirty"!==a&&!b[a].auto&&(d=b[a].typetype.toLowerCase(),e=c.sets[a],"undefiend"!==e&&"blob"!==d)){if(null===e)e="string"===d||"clob"===d?"'"+b[a]["default"]+"'":b[a]["default"];else if(""===e)if("string"===d||"clob"===d)e="'"+b[a]["default"]+"'";else{if("int"===d||"float"===d||"date"===d||"bool"===d)e=b[a]["default"]}else"string"===d||"clob"===d?e="'"+e+"'":"date"===d&&(e="'"+f.datetime.format(e,"yyyy-MM-dd HH:mm:ss")+"'");g.push(a+" \x3d "+e)}if(0<g.length)g="set "+g.join(",")+"";else throw"function updateRecord Error. No 'set'.";1===h.length?k.push({logic:"and",condition:l?" id \x3d '"+h[0]+"'":" id \x3d "+h[0]}):1<h.length&&k.push({logic:"and",condition:l?" id in ('"+h.join("','")+"')":" id in ("+h.join(",")+")"});if(1>k.length)throw"function updateRecord Error. No 'where'.";return"update "+c.table+" r\n"+g+" \nwhere "+this.getWhere(k)},updateRecord:function(c){var b={success:!1,value:""},a=c.sql||this.getUpdateSql(c);b.success=0<=this.update1(a);b.args=c;return b},getQuerySql:function(c){var b="",a="",e=[],d="",g="",k="",b="";if(c.sql)b=c.sql;else{b="select "+(c.select?c.select:"*")+"\n";a="from "+c.from+"\n";e=f.trim(c.where);d=c.groupby?c.groupby+"\n":"";g=c.orderby?c.orderby+"\n":"";k=c.limit?c.limit:"";e=e&&0<e.length?"where "+this.getWhere(e)+"\n":"";if(!c.from||""===f.trim(c.from))throw"function queryPage Error. No 'from'.";b=b+a+e+d+g+k}return b},queryRecord:function(c){var b=null,a={success:!0,value:""},b=this.getQuerySql(c),b=c._queryOptions&&c._queryOptions.queryAsArray?this.query1Array(b,c._queryOptions):this.query1String(b,c._queryOptions);!c.limit&&b&&f.isNumber(b.count)&&(c.count=b.count,c.start=0,c.end=0<c.count?c.count-1:-1);a.value=b.data;a.args=c;return a},queryPage:function(c){var b="",a="",e=[],d="",g="",k="",b="",h=null,l={success:!0,value:""};if(c.sql)b=c.sql;else{b="select "+(c.select?c.select:"*")+"\n";a="from "+c.from+"\n";e=f.trim(c.where);d=c.groupby?c.groupby+"\n":"";g=c.orderby?c.orderby+"\n":"";k=c.limit?c.limit:"";e=e&&0<e.length?"where "+this.getWhere(e)+"\n":"";if(!c.from||""===f.trim(c.from))throw"function queryPage Error. No 'from'.";c.limit&&(h=this.query1Array("select count(*) as c_\nfrom (select 1 as c_\n"+a+e+d+") r",c._queryOptions),c.count=h&&0<h.count?h.data[0].c_:-1);b=b+a+e+d+g+k}h=c._queryOptions&&c._queryOptions.queryAsArray?this.query1Array(b,c._queryOptions):this.query1String(b,c._queryOptions);!c.limit&&h&&f.isNumber(h.count)&&(c.count=h.count,c.start=0,c.end=0<c.count?c.count-1:-1);l.value=h.data;l.args=c;return l},updateChildren:function(c){var b,a=f.trim(c.where);b="";var e={success:!1,value:""};b="set r.children \x3d (select count(*) from (select * from "+c.table+") as d where d.idp \x3d r.id)\n";a=a&&0<a.length?"where "+this.getWhere(a)+"\n":"";b="update "+c.table+" r\n"+b+a;e.success=0<=this.update1(b);e.args=c;return e}});p._riasdMeta={visual:!1,iconClass:"riaswDbMySQLIcon",iconClass16:"riaswDbMySQLIcon16",defaultParams:function(c){return f.mixinDeep({dbType:"mysql"},c)}};return p});