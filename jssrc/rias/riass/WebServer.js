define(["rias/riass/riass","rias/riass/FileMixin"],function(d,n){var b=javax.servlet.http.HttpServletResponse,p=java.nio.file.FileSystems.getDefault(),f=java.nio.file.StandardWatchEventKinds,q=f.ENTRY_CREATE,r=f.ENTRY_MODIFY,m=f.ENTRY_DELETE,t=f.OVERFLOW;return d.declare("rias.riass.WebServer",[d.ObjectBase,n],{debugLevel:d.host.debugLevel(),config:null,path:null,dbs:null,defaultDbName:"db/riastudio",defaultDb:null,create:function(a){this.appName=a.appName;delete a.appName;this.config=a||{};this.config.path||(this.config.path={});this.path||(this.path={});this.config.dbConfig||(this.config.dbConfig={});this.dbs={};this.config.defaultDbName&&(this.defaultDbName=this.config.defaultDbName);this.inherited(arguments)},hasRight:function(a,e,c){a=0;for(e=e.split("/").length;a<e;a++);return 1},encodeURI:function(a){return encodeURI(d.host.jsString(a))},decodeURI:function(a){return decodeURI(d.host.jsString(a))},fetchByName:function(a,e,c){var d=this.getAttribute(a,e,c);return null==d?this.getParameter(a,e,c):d},getParameter:function(a,e,c){e=a.getParameter(e);return null==e?null:d.host.toType(e,c||_typeStr)},getAttribute:function(a,e,c){e=a.getAttribute(e);return null==e?null:d.host.toType(e,c)},setAttribute:function(a,e,c){return a.setAttribute(e,c)},getAttributeNames:function(a){for(var e={},c,b=a.getAttributeNames();b.hasMoreElements();)c=d.host.jsString(b.nextElement()),e[c]=this.getAttribute(a,c);return e},getParameters:function(a){for(var e={},c,b=a.getParameterNames();b.hasMoreElements();)c=d.host.jsString(b.nextElement()),e[c]=this.getParameter(a,c);return e},getRequestURI:function(a){return this.decodeURI(a.getRequestURI())},getRequestURL:function(a){return this.decodeURI(a.getRequestURL())},getServletPath:function(a){return this.decodeURI(a.getServletPath())},getPathInfo:function(a){return this.decodeURI(a.getPathInfo())},getQueryString:function(a){return d.host.toString(a.getQueryString())},getMethod:function(a){return d.host.toString(a.getMethod())},response:function(a,e,c,b,h,l){try{d.host.response(e,c,b,h||void 0==h?d.mixin({min:this.config.respGzipMinSize,max:this.config.respGzipMaxSize},d.isObject(h)?h:{}):!1,l)}catch(g){d.host.response(e,this.responseCode.SC_INTERNAL_SERVER_ERROR,this.getRequestURL(a),!1,l),d.log(3,"WebServer",a,"Response error: "+g+"\n")}},responseCode:{SC_CONTINUE:b.SC_CONTINUE,SC_SWITCHING_PROTOCOLS:b.SC_SWITCHING_PROTOCOLS,SC_OK:b.SC_OK,SC_CREATED:b.SC_CREATED,SC_ACCEPTED:b.SC_ACCEPTED,SC_NON_AUTHORITATIVE_INFORMATION:b.SC_NON_AUTHORITATIVE_INFORMATION,SC_NO_CONTENT:b.SC_NO_CONTENT,SC_RESET_CONTENT:b.SC_RESET_CONTENT,SC_PARTIAL_CONTENT:b.SC_PARTIAL_CONTENT,SC_MULTIPLE_CHOICES:b.SC_MULTIPLE_CHOICES,SC_MOVED_PERMANENTLY:b.SC_MOVED_PERMANENTLY,SC_MOVED_TEMPORARILY:b.SC_MOVED_TEMPORARILY,SC_FOUND:b.SC_FOUND,SC_SEE_OTHER:b.SC_SEE_OTHER,SC_NOT_MODIFIED:b.SC_NOT_MODIFIED,SC_USE_PROXY:b.SC_USE_PROXY,SC_TEMPORARY_REDIRECT:b.SC_TEMPORARY_REDIRECT,SC_BAD_REQUEST:b.SC_BAD_REQUEST,SC_UNAUTHORIZED:b.SC_UNAUTHORIZED,SC_PAYMENT_REQUIRED:b.SC_PAYMENT_REQUIRED,SC_FORBIDDEN:b.SC_FORBIDDEN,SC_NOT_FOUND:b.SC_NOT_FOUND,SC_METHOD_NOT_ALLOWED:b.SC_METHOD_NOT_ALLOWED,SC_NOT_ACCEPTABLE:b.SC_NOT_ACCEPTABLE,SC_PROXY_AUTHENTICATION_REQUIRED:b.SC_PROXY_AUTHENTICATION_REQUIRED,SC_REQUEST_TIMEOUT:b.SC_REQUEST_TIMEOUT,SC_CONFLICT:b.SC_CONFLICT,SC_GONE:b.SC_GONE,SC_LENGTH_REQUIRED:b.SC_LENGTH_REQUIRED,SC_PRECONDITION_FAILED:b.SC_PRECONDITION_FAILED,SC_REQUEST_ENTITY_TOO_LARGE:b.SC_REQUEST_ENTITY_TOO_LARGE,SC_REQUEST_URI_TOO_LONG:b.SC_REQUEST_URI_TOO_LONG,SC_UNSUPPORTED_MEDIA_TYPE:b.SC_UNSUPPORTED_MEDIA_TYPE,SC_REQUESTED_RANGE_NOT_SATISFIABLE:b.SC_REQUESTED_RANGE_NOT_SATISFIABLE,SC_EXPECTATION_FAILED:b.SC_EXPECTATION_FAILED,SC_INTERNAL_SERVER_ERROR:b.SC_INTERNAL_SERVER_ERROR,SC_NOT_IMPLEMENTED:b.SC_NOT_IMPLEMENTED,SC_BAD_GATEWAY:b.SC_BAD_GATEWAY,SC_SERVICE_UNAVAILABLE:b.SC_SERVICE_UNAVAILABLE,SC_GATEWAY_TIMEOUT:b.SC_GATEWAY_TIMEOUT,SC_HTTP_VERSION_NOT_SUPPORTED:b.SC_HTTP_VERSION_NOT_SUPPORTED},getConditionSrv:function(a,e,c,d,b){return a?a.getCondition(e,c,d,b):this.defaultDb.getCondition(e,c,d,b)},getEqualStrSrv:function(a,e,c){return a?a.getEqualStr(e,c):this.defaultDb.getEqualStr(e,c)},getLikeStrSrv:function(a,e,c){return a?a.getLikeStr(e,c):this.defaultDb.getLikeStr(e,c)},getWhereSrv:function(a,e){return a?a.getWhere(e):this.defaultDb.getWhere(e)},getOrderBySrv:function(a,e,c){return a?a.getOrderBy(e,c):this.defaultDb.getOrderBy(e,c)},getLimitSrv:function(a,e,c){return a?a.getLimit(e,c):this.defaultDb.getLimit(e,c)},loadDbs:function(a){var e=this,c,b,h,l;for(c in a)if(a.hasOwnProperty(c)&&(b=a[c],d.isObjectExact(b)))try{d.log(1,"WebServer","Setting DB Connection ..."+c),"mysql"==b.dbType&&d.require(["rias/riasdb/DbMySQL"],function(a){try{h=new a({server:e,dbType:b.dbType,dbConnName:c,dbConnConfig:b,defaultCatalog:b.defaultCatalog,maxResultRecords:b.maxResultRecords?b.maxResultRecords:999,afterGetDbDefine:function(a){try{l="serverApp/db/"+c.replace(/\\|\//,"_")+".json",e.writeJson(l,"serverApp",h.dbTables,{},!0),d.log(1,"WebServer","Save DB define in "+l)}catch(b){d.log(3,"WebServer","Save DB define Error: '"+c+"', "+b)}}}),e.dbs[c]=h,h.getDbDefine()}catch(g){d.log(3,"WebServer","Setting DB Connection Error: '"+c+"', "+g)}})}catch(g){d.log(3,"WebServer","Setting DB Connection Error: '"+c+"', "+g)}e.defaultDb=e.dbs[e.defaultDbName];e.defaultDb||d.log(2,"WebServer","There's no defaultDb: '"+e.defaultDbName+"'.")},startWebServer:function(a){throw Error("Unimplemented API: rias.riass.WebServer.startWebServer");},_monitorPath:{},monitor:function(a,b){function c(a){var b,e;a=d.host.jsString(a);a=k.convertFilePathName(a);try{a=d.host.newFile(a),b=a.toPath(),e=b.register(h,q,r,m),k._monitorPath[e]=b,d.forEach(a.listFiles(),function(a){a.directory&&c(a)})}catch(f){d.log(3,"FileMonitor","Add dir to monitor error: '"+a+"', \n"+f)}}var k=this,h=p.newWatchService();d.isString(a)?c(a):d.isArray(a)&&d.forEach(a,function(a){c(a)});d.host.newThread(function(){for(;;)try{var a=h.take(),c;d.forEach(d.host.jsArray(a.pollEvents()),function(d){c=d.kind();if(c!==t){var h=k._monitorPath[a];h&&b(h.resolve(d.context()),c)}});a.reset()}catch(f){d.log(3,"FileMonitor","FileMonitor Error: "+f+"\n"+f.javaException)}}).start()},startFileMonitor:function(a){function b(a,e){c._cacheAction&&c._cacheAction.remove(a);d.undef(a);d.log(1,"FileMonitor",'undef("'+a+'")');if(e)try{d.require([a],function(){d.log(1,"FileMonitor",'require(["'+a+'"]) ok.')})}catch(g){d.log(3,"FileMonitor",'require(["'+a+'"]) Error.\n'+g.javaExcception)}}var c=this;try{d.log(1,"FileMonitor","Starting FileMonitor ..."),c._monitorPath={},c.monitor(a,function(a,f){var g;try{g=c.getFilePathName(a+""),/\.js$/.test(g)&&(g=g.replace(/\.js$/,""),/riass\//.test(g)||(g=c.convertFilePathName(g,"",!0),d.require.modules[c.appName+"/"+g]&&b(c.appName+"/"+g,f!=m)))}catch(k){d.log(3,"FileMonitor","The FileMonitor Error: "+k+"\n"+k.javaException)}})}catch(f){d.log(3,"FileMonitor","Start FileMonitor Error: "+f+"\n"+f.javaException)}},start:function(){var a=this,b=this.path,c=this.config.path||{};try{d.log(1,"WebServer","Initialize WebServer ..."),a.debugLevel=d.host.debugLevel(),b.riasLib=a.getFilePathName(c.riasLib?c.riasLib:"jssrc/rias"),b.webLib=a.getFilePathName(c.webLib?c.webLib:"jssrc/webLib"),b.appRoot=a.getFilePathName(c.appRoot?c.appRoot:"jssrc/riasApp"),a._initPackagePath(),d.log(1,"WebServer","WebServer.path.appRoot is '"+b.appRoot+"'."),d.require(["dojo/i18n!"+a.appName+"/serverApp/nls/appi18n"],function(b){d.i18n[a.appName]=b}),a.loadDbs(a.config.dbConfig),a.startFileMonitor("serverApp/act"),a.startWebServer(a.config)}catch(f){d.log(3,"WebServer","Initialize WebServer Error: "+f+"\n"+f.javaException)}},stop:function(){},getSession:function(a){return null},getOper:function(a){return{}}})});